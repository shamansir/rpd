/* RPD v0.1.0
 https://shamansir.github.io/rpd
 LICENSE: MIT (c) 2015 Anton Kotenko <shaman.sir@gmail.com> */

var Rpd=function(){function a(b){this.name=b;this.targets=Kefir.emitter();this.renderers=Kefir.emitter();b={"model/new":function(b){return{model:b}},"node/add":function(b){return{node:b}},"node/remove":function(b){return{node:b}}};this.event=D(b);this.events=F(b,this.event);Kefir.combine([this.events,this.targets.scan(N),this.renderers.scan(N)]).onValue(function(b){var c=b[0],a=b[2];G(b[1],function(b){G(a,function(a){a(b,c)})})});this.event["model/new"].emit(this)}function d(b,c){this.type=b||"core/empty";
this.id=E();var a=v(x[this.type]);a||B("Node type "+this.type+" is not registered!");this.def=a;this.name=c||a.name||"Unnamed";this.def=a;this.render=I(a.render);var f=this,a={"node/turn-on":function(b){return{node:f}},"node/ready":function(b){return{node:f}},"node/process":function(b){return{inlets:b[0],outlets:b[1],node:f}},"node/turn-off":function(b){return{node:f}},"inlet/add":function(b){return{inlet:b}},"inlet/remove":function(b){return{inlet:b}},"outlet/add":function(b){return{outlet:b}},"outlet/remove":function(b){return{outlet:b}}};
this.event=D(a);this.events=F(a,this.event);n[C]?n[C].addNode(this):B("No model started!");if(this.def.handle)this.events.onValue(function(b){if(f.def.handle[b.type])f.def.handle[b.type](b)});if(this.def.process){var g=this.def.process,f=this;Kefir.combine([this.event["inlet/add"].flatMap(function(b){var a=b.event["inlet/update"].map(function(a){return{inlet:b,alias:b.alias,value:a}});f.def.tune&&(a=f.def.tune(a));return a}).scan(function(b,a){var c=a.alias,M=a.inlet,f,e;if(b)return f=b.prev,e=b.cur,
f[c]=e[c],e[c]=a.value,b.source=M,b;f={};e={};e[c]=a.value;return{prev:f,cur:e,source:M}},null).filter(function(b){return!(b&&b.source.cold)}),this.event["outlet/add"].scan(function(b,a){b=b||{};b[a.alias]=a;return b},null)]).onValue(function(b){var a=b[0]||{prev:{},cur:{}};b=b[1]||{};var c=g(a.cur,a.prev);f.event["node/process"].emit([a.cur,c,a.prev]);for(var M in c)b[M]&&b[M].send(c[M])})}if(this.def.inlets){this.inlets={};for(var e in this.def.inlets)a=this.def.inlets[e],a=this.addInlet(a.type,
e,a.name,a.default,a.hidden,a.readonly,a.cold),this.inlets[e]=a}if(this.def.outlets)for(e in this.outlets={},this.def.outlets)a=this.def.outlets[e],a=this.addOutlet(a.type,e,a.name,a.default),this.outlets[e]=a;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/ready"].emit(this)}function c(b,a,c,f,e,d,h,k){this.type=b||"core/bool";this.id=E();var l=v(g[this.type]);l||B("Inlet type "+this.type+" is not registered!");this.def=l;(this.alias=c||f||l.alias)||B("Inlet should have either alias or name");
this.name=f||this.alias||l.name||"Unnamed";this.node=a;this.hidden=d||!1;this.readonly=K(h||l.readonly)?h||l.readonly:!0;this.cold=k||!1;this.default=K(e)?e:l.default;this.value=Kefir.bus();this.render=I(l.render);var p=this;b={"inlet/update":function(b){return{inlet:p,value:b}}};this.event=D(b);var m=this.event["inlet/update"];a=m.merge(this.value);l.tune&&(a=l.tune(a));l.accept&&(a=a.flatten(function(b){if(l.accept(b))return[b];m.error();return[]}));l.adapt&&(a=a.map(l.adapt));this.event["inlet/update"]=
a.onValue(function(){});this.events=F(b,this.event)}function k(b,a,c,f,e){this.type=b||"core/bool";this.id=E();(b=v(g[this.type]))||B("Outlet type "+this.type+" is not registered!");this.def=b;(this.alias=c||f||b.alias)||B("Outlet should have either alias or name");this.name=f||this.alias||b.name||"Unnamed";this.node=a;this.default=K(e)?e:b.default;this.value=Kefir.bus();this.render=I(b.render);var d=this;a={"outlet/update":function(b){return{outlet:d,value:b}},"outlet/connect":function(b){return{outlet:d,
link:b}},"outlet/disconnect":function(b){return{outlet:d,link:b}}};this.event=D(a);this.event["outlet/update"]=this.event["outlet/update"].merge(this.value).onValue(function(){});this.events=F(a,this.event);Kefir.sampledBy([this.event["outlet/update"]],[this.event["outlet/connect"]]).onValue(function(b){d.value.emit(b[0])})}function r(b,a,c,e,d){this.type=b||"core/pass";this.id=E();(b=v(f[this.type]))||B("Link type "+this.type+" is not registered!");this.def=b;this.name=d||b.name||"";this.outlet=
a;this.inlet=c;this.adapter=e||b.adapt||void 0;var g=this;this.receiver=a.node.id!==c.node.id?function(b){return function(a){b.pass(a)}}(g):function(b){setTimeout(function(){g.pass(b)},0)};a={"link/enable":function(){return{link:g}},"link/disable":function(){return{link:g}},"link/pass":function(b){return{link:g,value:b}},"link/adapt":function(b){return{link:g,before:b[0],after:b[1]}}};this.event=D(a);this.events=F(a,this.event);this.enabled=Kefir.merge([this.event["link/disable"].mapTo(!1),this.event["link/enable"].mapTo(!0)]).toProperty(!0);
this.event["link/pass"].filterBy(this.enabled).onValue(function(b){c.receive(g.adapt(b))});Kefir.sampledBy([this.event["link/pass"]],[this.event["link/enable"]]).onValue(function(b){g.pass(b[0])})}function K(b){return"undefined"!==typeof b}function v(b){return b?"function"===typeof b?b():b:null}function I(b){if(!b)return{};var a={},c;for(c in b)a[c]=v(b[c]);return a}function D(b){var a={},c;for(c in b)a[c]=Kefir.emitter();return a}function F(b,a){var c=Kefir.pool(),f;for(f in b)(function(b,f){c.plug(a[b].map(function(a){a=
f(a);a.type=b;return a}))})(f,b[f]);return c}function B(b,a){a=a||Error(b);console&&(console.error?console.error(a):console.log(a));throw a;}function E(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function N(b,a){return[a,Array.isArray(b)?b:[b,null]]}function G(b,a){b&&(Array.isArray(b)?(a(b[0]),G(b[1],a)):a(b))}function L(b,a,c){for(var f=[],e=0,g=a.length;e<g;e++)f.push(a[e](c));return function(a,c){b(a,c);for(var e=0,g=f.length;e<g;e++)f[e](a,c)}}var x={},f={},g={},
h={},e={},m={},C=-1,n=[];a.prototype.attachTo=function(b){this.targets.emit(b);return this};a.prototype.addNode=function(b){this.events.plug(b.events);this.event["node/add"].emit(b);b.turnOn();return this};a.prototype.removeNode=function(b){b.turnOff();this.event["node/remove"].emit(b);this.events.unplug(b.events);return this};a.prototype.renderWith=function(b,a){if(!e[b])throw Error("Renderer "+b+" is not registered");var c=e[b](a);m[b]&&m[b].length?this.renderers.emit(L(c,m[b]),a):this.renderers.emit(c);
return this};a.start=function(b){b=new a(b);n.push(b);C++;return b};d.prototype.turnOn=function(){this.event["node/turn-on"].emit(this)};d.prototype.turnOff=function(){this.event["node/turn-off"].emit(this)};d.prototype.addInlet=function(b,a,f,e,g,d,h){b=new c(b,this,a,f,e,g,d,h);this.events.plug(b.events);this.event["inlet/add"].emit(b);b.toDefault();return b};d.prototype.addOutlet=function(b,a,c,f){b=new k(b,this,a,c,f);this.events.plug(b.events);this.event["outlet/add"].emit(b);return b};d.prototype.removeInlet=
function(b){this.event["inlet/remove"].emit(b);this.events.unplug(b.events)};d.prototype.removeOutlet=function(b){this.event["outlet/remove"].emit(b);this.events.unplug(b.events)};c.prototype.receive=function(b){this.value.emit(b)};c.prototype.stream=function(b){this.value.plug(b)};c.prototype.toDefault=function(){K(this.default)&&this.default instanceof Kefir.Stream?this.stream(this.default):this.receive(this.default)};k.prototype.connect=function(b,a){var c=new r(null,this,b,a);this.events.plug(c.events);
this.value.onValue(c.receiver);this.event["outlet/connect"].emit(c);return c};k.prototype.disconnect=function(b){this.event["outlet/disconnect"].emit(b);this.value.offValue(b.receiver);this.events.unplug(b.events)};k.prototype.send=function(b){this.value.emit(this.adapt?this.adapt(b):b)};k.prototype.stream=function(b){this.value.plug(this.adapt?b.map(this.adapt):b)};r.prototype.pass=function(b){this.event["link/pass"].emit(b)};r.prototype.adapt=function(b){if(this.adapter){var a=this.adapter(b);this.event["link/adapt"].emit([b,
a]);return a}this.event["link/adapt"].emit([b,b]);return b};r.prototype.enable=function(){this.event["link/enable"].emit()};r.prototype.disable=function(){this.event["link/disable"].emit()};r.prototype.disconnect=function(){this.outlet.disconnect(this)};return{Model:a,Node:d,Inlet:c,Outlet:k,Link:r,nodetype:function(b,a){x[b]=a},linktype:function(b,a){f[b]=a},channeltype:function(b,a){g[b]=a},nodedescription:function(b,a){h[b]=a},renderer:function(b,a){e[b]=a},subrenderer:function(b,a){m[b]||(m[b]=
[]);m[b].push(a)},noderenderer:function(b,a,c){if(!x[b])throw Error("Node type "+b+" is not registered");x[b].render||(x[b].render={});x[b].render[a]=c},channelrenderer:function(b,a,c){if(!g[b])throw Error("Channel type "+b+" is not registered");g[b].render||(g[b].render={});g[b].render[a]=c},allNodeTypes:x,allDescriptions:h,currentModel:function(){return n[C]}}}();(function(){function a(a){function g(b){b.preventDefault();b.stopPropagation()}function h(b){return{x:b.clientX,y:b.clientY}}function e(b){b=b.getBoundingClientRect();return{x:b.left,y:b.top}}function m(b){return function(a){return{pos:a,target:b}}}function C(b){return!b}function n(b,a,c,f){Kefir.fromEvent(b,"click").tap(g).mapTo(f||!1).scan(C).onValue(function(b){b?a():c()})}function b(b,a,Q,f,e){e=c("div","rpd-value-editor");var u=Kefir.emitter(),d=Kefir.emitter();a.disableEditor=d;b.render.html.edit(e,
b,u).onValue(function(a){b.receive(a)});Kefir.sampledBy([b.event["inlet/update"]],[Kefir.merge([Kefir.fromEvent(f,"click").tap(g).mapTo(!0),Kefir.fromEvent(Q,"click").merge(d).mapTo(!1)]).toProperty(!1).skipDuplicates()]).map(function(b){return{lastValue:b[0],startEditing:b[1],cancelEditing:!b[1]}}).onValue(function(b){b.startEditing?(a.link&&a.link.disable(),u.emit(b.lastValue),f.classList.add("rpd-editor-enabled")):b.cancelEditing&&f.classList.remove("rpd-editor-enabled")});f.classList.add("rpd-editor-disabled");
f.appendChild(e)}function x(b,a){if(a)for(var c in a)(function(a,c){b.event["inlet/add"].filter(function(b){return b.alias===c}).onValue(function(b){a.default&&b.receive(a.default());if(a.valueOut)a.valueOut.onValue(function(a){b.receive(a)})})})(a[c],c)}function E(b,a){for(var c,f,t,u=0,g=a.length;u<g;u++)c=a[u].link,f=a[u].elm,t=y[c.inlet.id].connectorElm,c=J[c.outlet.id].connectorElm,t=e(t),c=e(c),I(f,c.x,c.y,t.x,t.y)}function G(b,a,c,f){c.classList.add("rpd-drag-handle");var t;Kefir.fromEvent(c,
"mousedown").map(h).flatMap(function(b){f.classList.add("rpd-dragging");var c=e(f),Q=b.x-c.x,d=b.y-c.y;t=null;f.style.zIndex=1;return Kefir.fromEvent(a,"mousemove").tap(g).takeUntilBy(Kefir.fromEvent(a,"mouseup")).map(h).map(function(b){return{x:b.x-Q,y:b.y-d}}).onEnd(function(){f.classList.remove("rpd-dragging");f.style.zIndex=0;if(t)for(var b=0,a=t.length;b<a;b++)t[b].elm.style.zIndex=2})}).onValue(function(a){f.style.left=a.x+"px";f.style.top=a.y+"px";t||(t=D(b,l,function(b){b.elm.style.zIndex=
3}));E(b,t)})}function N(b,a,f){var e={},t=[],d,h,q,O;for(d in a)q=d.split("/"),h=q[0],O=q[1],t.push([q,h,O]),e[h]||(e[h]={}),e[h][O]=a[d];var p=c("dl","rpd-nodelist"),m,l,R;for(h in e){m=k("dd","rpd-toolkit-name",h);p.appendChild(m);a=c("dt");t=c("dl","rpd-toolkit");d=e[h];for(O in d)d=h+"/"+O,l=k("dd","rpd-node-title",O),R=k("span","rpd-add-node","+ Add"),l.appendChild(R),q=k("dd","rpd-node-description",f[d]||"[No Description]"),t.appendChild(l),t.appendChild(q),q.classList.add("rpd-collapsed"),
function(b){n(l,function(){b.classList.add("rpd-collapsed")},function(){b.classList.remove("rpd-collapsed")})}(q),function(b){Kefir.fromEvent(R,"click").tap(g).onValue(function(){new Rpd.Node(b)})}(d);a.appendChild(t);p.appendChild(a);(function(b){n(m,function(){b.classList.add("rpd-collapsed")},function(){b.classList.remove("rpd-collapsed")},!0)})(t)}b.appendChild(p);var w=c("span","rpd-collapse-nodelist");w.innerText=w.textContent=">>";n(w,function(){w.classList.add("rpd-collapsed");w.innerText=
w.textContent="<<";p.classList.add("rpd-collapsed")},function(){w.classList.remove("rpd-collapsed");w.innerText=w.textContent=">>";p.classList.remove("rpd-collapsed")},!0);b.appendChild(w)}var H,J,y,l,p=d(a,B),L=function(){var b,a,c,f,t,d,k,q=function(b){return function(){return y[b.id].link}};return{init:function(e){k=e;b=Kefir.fromEvent(e,"click");a=Kefir.pool();c=Kefir.pool();f=Kefir.emitter();t=Kefir.emitter();d=Kefir.merge([f.mapTo(!0),t.mapTo(!1)]).toProperty(!1)},subscribeOutlet:function(q,
l){c.plug(Kefir.fromEvent(l,"click").map(h).map(m(q)));Kefir.fromEvent(l,"click").tap(g).filterBy(c.awaiting(d)).map(h).onValue(function(d){f.emit();var g=e(l),u=v(g.x,g.y,d.x,d.y,p.linkWidth);k.appendChild(u);return Kefir.fromEvent(k,"mousemove").takeUntilBy(Kefir.merge([a,c.mapTo(!1),b.mapTo(!1)]).take(1).onValue(function(b){if(b){b=b.target;var a=y[b.id].link;a&&a.outlet.disconnect(a);q.connect(b)}})).map(h).onValue(function(b){I(u,g.x,g.y,b.x,b.y)}).onEnd(function(){k.removeChild(u);t.emit()})})},
subscribeInlet:function(l,n){a.plug(Kefir.fromEvent(n,"click").map(h).map(m(l)));Kefir.fromEvent(n,"click").tap(g).filterBy(a.awaiting(d)).filter(q(l)).onValue(function(d){var g=y[l.id].link,u=g.outlet;u.disconnect(g);f.emit();var q=e(J[u.id].connectorElm),m=v(q.x,q.y,d.x,d.y,p.linkWidth);k.appendChild(m);return Kefir.fromEvent(k,"mousemove").takeUntilBy(Kefir.merge([a,c.mapTo(!1),b.mapTo(!1)]).take(1).onValue(function(b){if(b){b=b.target;var a=y[b.id].link;a&&a.outlet.disconnect(a);u.connect(b)}})).map(h).onValue(function(b){I(m,
q.x,q.y,b.x,b.y)}).onEnd(function(){k.removeChild(m);t.emit()})})}}}(),P=Rpd.allDescriptions;return{"model/new":function(b,a){H={};J={};y={};l={};b.classList.add("rpd-model");p.layout&&b.classList.add("rpd-layout-"+p.layout);p.valuesOnHover?b.classList.add("rpd-values-on-hover"):b.classList.add("rpd-values-always-shown");p.showBoxes&&b.classList.add("rpd-show-boxes");b.style.height=document.documentElement.clientHeight+"px";Kefir.fromEvent(b,"resize").onValue(function(){b.style.height=document.documentElement.clientHeight+
"px"});L.init(b);p.renderNodeList&&N(b,Rpd.allNodeTypes,P);Kefir.fromEvent(b,"selectstart").onValue(function(b){b.preventDefault()})},"node/add":function(b,a){var f=a.node,e=c("div","rpd-node-box"),d=c("table","rpd-node"),u,h,q,l,m;if("quartz"==p.layout){u=c("thead","rpd-title");h=c("tr");var n=c("tr","rpd-remove-button");m=c("th");m.innerText=m.textContent="x";n.appendChild(m);u.appendChild(n);n=c("th");n.setAttribute("colspan",3);n.appendChild(k("span","rpd-name",f.name));p.showTypes&&n.appendChild(k("span",
"rpd-type",f.type));h.appendChild(n);u.appendChild(h);var C=c("tbody","rpd-content"),r=c("tr"),w=c("td","rpd-inlets");l=c("table");var v=c("tbody");h=v;l.appendChild(v);w.appendChild(l);l=c("div");v=c("td","rpd-body");q=c("table");var z=c("tr"),A=c("td");A.appendChild(l);z.appendChild(A);q.appendChild(z);v.appendChild(q);var z=c("td","rpd-outlets"),A=c("table"),y=c("tbody");q=y;A.appendChild(y);z.appendChild(A);r.appendChild(w);r.appendChild(v);r.appendChild(z);C.appendChild(r);d.appendChild(u);d.appendChild(C)}else"pd"==
p.layout&&(m=c("tr","rpd-inlets"),w=c("td"),l=c("table"),h=v=c("tbody"),l.appendChild(v),w.appendChild(l),m.appendChild(w),d.appendChild(m),n=c("tr","rpd-remove-button"),m=c("td"),m.innerText=m.textContent="x",n.appendChild(m),d.appendChild(n),r=c("tr","rpd-content"),n=c("td","rpd-title"),n.appendChild(k("span","rpd-name",f.name)),p.showTypes&&n.appendChild(k("span","rpd-type",f.type)),r.appendChild(n),v=c("td","rpd-body"),l=c("div"),q=c("table"),z=c("tr"),A=c("td"),A.appendChild(l),z.appendChild(A),
q.appendChild(z),v.appendChild(q),r.appendChild(v),d.appendChild(r),u=c("tr","rpd-outlets"),z=c("td"),A=c("table"),q=y=c("tbody"),A.appendChild(y),z.appendChild(A),u.appendChild(z),d.appendChild(u),u=n);d.classList.add("rpd-"+f.type.replace("/","-"));e.style.zIndex=0;P[f.type]&&(n.title=P[f.type]);F(f,e,d,p.boxSize,[b.offsetWidth,b.offsetHeight]);e.appendChild(d);b.appendChild(e);H[f.id]={box:e,elm:d,body:l,inletsTrg:h,outletsTrg:q};f.render.html&&f.render.html.first&&x(f,f.render.html.first(l));
p.nodesMovingAllowed&&G(f,b,u,e);Kefir.fromEvent(m,"click").tap(g).onValue(function(){Rpd.currentModel().removeNode(f)})},"node/process":function(b,a){var c=a.node;c.render.html&&c.render.html.always&&c.render.html.always(H[c.id].body,a.inlets,a.outlets)},"node/remove":function(b,a){for(var c=a.node,f=H[c.id],e=D(c,l),d,g=0,h=e.length;g<h;g++)d=e[g],d.link.outlet.disconnect(d.link);b.removeChild(f.box);H[c.id]=null},"inlet/add":function(a,f){var e=f.inlet;if(!e.hidden){var d=H[e.node.id].inletsTrg,
g,h,l;"quartz"==p.layout?(g=c("tr","rpd-inlet rpd-stale"),l=c("td","rpd-connector"),valueHolder=c("td","rpd-value-holder"),h=c("span","rpd-value"),valueHolder.appendChild(h),g.appendChild(l),g.appendChild(valueHolder),g.appendChild(k("td","rpd-name",e.name)),p.showTypes&&g.appendChild(k("td","rpd-type",e.type))):"pd"==p.layout&&(g=c("td","rpd-inlet rpd-stale"),l=c("span","rpd-connector"),valueHolder=c("span","rpd-value-holder"),h=c("span","rpd-value"),valueHolder.appendChild(h),g.appendChild(l),g.appendChild(k("span",
"rpd-name",e.name)),g.appendChild(valueHolder),p.showTypes&&g.appendChild(k("span","rpd-type",e.type)));g.classList.add("rpd-"+e.type.replace("/","-"));d.appendChild(g);var m={elm:g,valueElm:h,connectorElm:l,disableEditor:null,link:null};y[e.id]=m;e.readonly&&g.classList.add("rpd-readonly");e.cold&&g.classList.add("rpd-cold");!e.readonly&&e.render.html&&e.render.html.edit&&b(e,m,a,valueHolder,h);e.event["inlet/update"].onError(function(){r(m,g,p.effectTime)});L.subscribeInlet(e,l)}},"inlet/update":function(b,
a){var c=a.inlet;if(!c.hidden){var f=y[c.id],e=f.elm,d=f.valueElm,g=c.def.show?c.def.show(a.value):a.value;d.innerText=d.textContent=g;c.render.html&&c.render.html.show?c.render.html.show(d,a.value,g):d.innerText=d.textContent=g;K(f,e,p.effectTime)}},"outlet/add":function(b,a){var f=a.outlet,e=H[f.node.id].outletsTrg,d,g,h;"quartz"==p.layout?(d=c("tr","rpd-outlet rpd-stale"),h=c("td","rpd-connector"),g=c("td","rpd-value"),p.showTypes&&d.appendChild(k("td","rpd-type",f.type)),d.appendChild(k("td",
"rpd-name",f.name)),d.appendChild(g),d.appendChild(h)):"pd"==p.layout&&(d=c("td","rpd-outlet rpd-stale"),h=c("span","rpd-connector"),g=c("span","rpd-value"),d.appendChild(h),d.appendChild(k("span","rpd-name",f.name)),d.appendChild(g),p.showTypes&&d.appendChild(k("span","rpd-type",f.type)));d.classList.add("rpd-"+f.type.replace("/","-"));e.appendChild(d);J[f.id]={elm:d,valueElm:g,connectorElm:h,links:{}};L.subscribeOutlet(f,h)},"outlet/update":function(b,a){var c=a.outlet,f=J[c.id],e=f.elm,d=f.valueElm;
d.innerText=d.textContent=a.value;c.render.html&&c.render.html.show?c.render.html.show(d,a.value):d.innerText=d.textContent=c.def.show?c.def.show(a.value):a.value;K(f,e,p.effectTime)},"outlet/connect":function(b,a){var c=a.link,f=c.outlet,e=J[f.id],d=y[c.inlet.id],g=e.connectorElm,h=d.connectorElm;e.links[f.id]=c;if(d.link)throw Error("Inlet is already connected to a link");d.link=c;d.disableEditor&&d.disableEditor.emit();f=g.getBoundingClientRect();h=h.getBoundingClientRect();h=v(f.left,f.top,h.left,
h.top,p.linkWidth);l[c.id]={elm:h,link:c};n(h,function(){c.enable()},function(){c.disable()});b.appendChild(h)},"outlet/disconnect":function(b,a){var c=a.link,f=l[c.id].elm,d=y[c.inlet.id];J[c.outlet.id].links[c.id]=null;d.link=null;l[c.id]=null;b.removeChild(f)},"link/enable":function(b,a){l[a.link.id].elm.classList.remove("rpd-disabled")},"link/disable":function(b,a){l[a.link.id].elm.classList.add("rpd-disabled")}}}function d(a,c){if(a){var d={},e;for(e in c)d[e]=c[e];for(e in a)d[e]=a[e];return d}return c}
function c(a,c){var d=document.createElement(a);c&&(d.className=c);return d}function k(a,c,d){a=document.createElement(a);c&&(a.className=c);a.innerText=a.textContent=d;return a}function r(a,c,d){c.classList.add("rpd-error");a.errRemoveTimeout&&clearTimeout(a.errRemoveTimeout);a.errRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-error");a.errRemoveTimeout=null},d||1)}function K(a,c,d){c.classList.remove("rpd-stale");c.classList.add("rpd-fresh");a.updRemoveTimeout&&clearTimeout(a.updRemoveTimeout);
a.updRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-fresh");c.classList.add("rpd-stale");a.updRemoveTimeout=null},d||1)}function v(a,d,h,e,m){var k=Math.sqrt((a-h)*(a-h)+(d-e)*(d-e));h=Math.atan2(e-d,h-a);e=c("span","rpd-link");e.style.position="absolute";e.style.zIndex=2;e.style.width=Math.floor(k)+"px";e.style.left=a+"px";e.style.top=d+"px";e.style.transformOrigin="left top";e.style.webkitTransformOrigin="left top";e.style.transform="rotateZ("+h+"rad)";e.style.webkitTransform="rotateZ("+
h+"rad)";m&&(e.style.height=m+"px");return e}function I(a,c,d,e,m){var k=Math.sqrt((c-e)*(c-e)+(d-m)*(d-m));e=Math.atan2(m-d,e-c);a.style.left=c+"px";a.style.top=d+"px";a.style.width=Math.floor(k)+"px";a.style.transform="rotateZ("+e+"rad)";a.style.webkitTransform="rotateZ("+e+"rad)"}function D(a,c,d){var e=[],k,r,n;for(n in c)c[n]&&(k=c[n],r=k.link,r.inlet.node.id===a.id||r.outlet.node.id===a.id)&&(e.push(k),d&&d(k,r));return e}function F(a,c,d,e,k){var r=(a.def.width||E)*e[0],n=x.length?x[x.length-
1]:null;a=[n?n[0]:0,n?n[1]+n[3]+L*e[1]:0,r,(a.def.height||N)*e[1]];a[1]+e[1]>k[1]&&(a[0]=a[0]+r+G*e[0],a[1]=0);x.push(a);c.style.left=Math.floor(a[0])+"px";c.style.top=Math.floor(a[1])+"px";d.style.minWidth=Math.floor(a[2])+"px";d.style.minHeight=Math.floor(a[3])+"px";x.push(a)}var B={layout:"quartz",valuesOnHover:!1,showTypes:!1,showBoxes:!1,nodesMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,boxSize:[100,40],linkWidth:null,effectTime:1E3},E=1,N=1,G=.5,L=1,x=[];Rpd.HtmlRenderer=a;Rpd.renderer("html",
function(c){var d=a(c);return function(a,c){if(d[c.type])d[c.type](a,c)}})})();Rpd.nodedescription("core/empty","Does not allow adding any inlets or outlets.");Rpd.nodetype("core/empty",{name:"Empty",handle:{"inlet/add":function(){throw Error("Empty node can not have any inlets");},"outlet/add":function(){throw Error("Empty node can not have any outlets");}}});Rpd.nodedescription("core/custom","May have any number of inlets and outlets, a target for extension.");Rpd.nodetype("core/custom",{name:"Custom"});
Rpd.nodetype("core/sum-of-three",{name:"Sum of Three",width:1.8,inlets:{a:{type:"core/number",name:"A"},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C"}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(a){return{sum:(a.a||0)+(a.b||0)+(a.c||0)}}});
Rpd.nodetype("core/sum-of-three-with-body",{name:"Sum of Three w/Body",width:1.8,inlets:{a:{type:"core/number",name:"A",default:1},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C",hidden:!0}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(a){return{sum:(a.a||0)+(a.b||0)+(a.c||0)}}});Rpd.nodedescription("core/hot-and-cold","An example of cold inlet.");
Rpd.nodetype("core/hot-and-cold",{name:"Hot and Cold",inlets:{hot:{type:"core/number",name:"A",default:1},cold:{type:"core/number",name:"B",default:1,cold:!0}},outlets:{value:{type:"core/any"}},process:function(a){return{value:[a.hot,a.cold]}}});Rpd.channeltype("core/any",{});Rpd.channeltype("core/boolean",{default:!1,adapt:function(a){return a?!0:!1}});Rpd.channeltype("core/number",{default:0,readonly:!1,accept:function(a){a=parseFloat(a);return!isNaN(a)&&isFinite(a)},adapt:function(a){return parseFloat(a)}});
Rpd.linktype("core/pass",{});Rpd.noderenderer("core/sum-of-three","html",{always:function(a,d,c){a.innerHTML="\u2211 ("+(d.a||"?")+", "+(d.b||"?")+", "+(d.c||"?")+") = "+(c.sum||"?")}});
Rpd.noderenderer("core/sum-of-three-with-body","html",function(){var a;return{first:function(d){var c=document.createElement("input");c.style.display="block";c.type="number";c.min=0;c.max=10;d.appendChild(c);a=document.createElement("span");d.appendChild(a);return{c:{default:function(){return c.value=0},valueOut:Kefir.fromEvent(c,"change").map(function(){return c.value})}}},always:function(d,c,k){a.innerHTML=a.textContent="\u2211 ("+(c.a||"0")+", "+(c.b||"0")+", "+(c.c||"0")+") = "+(k.sum||"?")}}});
Rpd.channelrenderer("core/number","html",{edit:function(a,d,c){var k=document.createElement("input");k.type="number";c.onValue(function(a){k.value=a});a.appendChild(k);return Kefir.fromEvent(k,"change").map(function(){return k.value})}});Rpd.channeltype("pd/t-num",{show:function(a){return a?a.value:"?"}});Rpd.channeltype("pd/spinner",{adapt:function(a){return{value:a,time:Date.now()}}});Rpd.channeltype("pd/t-wave",{});Rpd.channeltype("pd/t-obj",{show:function(a){return a?"[Some]":"[None]"}});Rpd.nodedescription("pd/number","Choose any number using a handy spinner.");
Rpd.nodetype("pd/number",{name:"num",inlets:{"in":{type:"pd/t-num",default:T(0)},spinner:{type:"pd/spinner",default:T(0),hidden:!0}},outlets:{out:{type:"pd/t-num"}},process:function(a){return a.spinner?50>Date.now()-a.spinner.time?{out:a.spinner.value}:{out:a.in}:{out:a.in}}});Rpd.nodedescription("pd/osc","Oscillator. That's it.");
Rpd.nodetype("pd/osc",{name:"osc",description:"Oscillator. That's it.",inlets:{wave:{type:"pd/t-wave",default:"sin"},freq:{type:"pd/t-num",default:T(440)}},outlets:{sound:{type:"pd/t-obj"}},process:function(a){return a.wave&&a.freq?{sound:T("osc",{wave:a.wave,freq:a.freq})}:null}});Rpd.nodedescription("pd/wave","Choose a wave type, like sine or saw.");Rpd.nodetype("pd/wave",{name:"wave",inlets:{wave:{type:"pd/t-wave",default:"sin",hidden:!0}},outlets:{wave:{type:"pd/t-wave"}},process:function(a){return{wave:a.wave}}});
Rpd.nodedescription("pd/plot","Draw your sound wave on a Canvas.");Rpd.nodetype("pd/plot",{name:"plot",inlets:{sound:{type:"pd/t-obj",default:null}},process:function(){}});Rpd.nodedescription("pd/play","Play a given sound. Control your volume safely.");
Rpd.nodetype("pd/play",function(){var a;return{name:"play",inlets:{sound:{type:"pd/t-obj",default:null}},tune:function(a){return a.throttle(50)},process:function(d,c){c.sound&&c.sound.pause();d.sound&&(a=d.sound,d.sound.play())},handle:{"node/turn-off":function(){a&&a.pause()}}}});Rpd.noderenderer("pd/number","html",function(){var a;return{first:function(d){var c=document.createElement("span");a=attachSpinner(c,0);d.appendChild(c);return{spinner:{default:function(){a.emit(0);return T(0)},valueOut:a.map(function(a){return T(parseFloat(a))})}}},always:function(d,c){c.spinner&&c.in&&50<Date.now()-c.spinner.time&&a.emit(c.in.value)}}});Rpd.noderenderer("pd/osc","html",{always:function(a,d){a.innerText=a.textContent=d.wave+"/"+d.freq}});
Rpd.noderenderer("pd/wave","html",{first:function(a){var d=document.createElement("select");d.appendChild(createOption("sin"));d.appendChild(createOption("saw"));d.appendChild(createOption("tri"));d.appendChild(createOption("pulse"));d.appendChild(createOption("fami"));a.appendChild(d);return{wave:{default:function(){return d.value="sin"},valueOut:Kefir.fromEvent(d,"change").map(function(){return d.options[d.selectedIndex].value})}}}});
Rpd.noderenderer("pd/plot","html",function(){var a;return{first:function(d){a=document.createElement("canvas");a.width=100;a.height=100;d.appendChild(a)},always:function(d,c){c.sound&&c.sound.plot({target:a})}}});function createOption(a,d){var c=document.createElement("option");c.value=a;c.innerText=c.textContent=a;d&&(c.selected="selected");return c}function extractPos(a){return{x:a.clientX,y:a.clientY}}function stopPropagation(a){a.stopPropagation()}
function attachSpinner(a,d){a.classList.add("rpd-pd-spinner");var c=d=d||0,k=Kefir.emitter();k.onValue(function(d){c=d;a.innerText=a.textContent=d});k.emit(d);Kefir.fromEvent(a,"mousedown").map(extractPos).flatMap(function(a){var d=c;return Kefir.fromEvent(document.body,"mousemove").map(extractPos).takeUntilBy(Kefir.fromEvent(document.body,"mouseup")).onValue(function(c){k.emit(d+(c.x-a.x))})}).onEnd(function(){});return k};
