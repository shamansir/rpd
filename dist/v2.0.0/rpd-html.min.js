/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Tue, 19 Jul 2016 01:35:15 GMT
 *
 * @version v2.0.0
 * @link https://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 *
 * Selected Renderers: html
 * Selected Styles: quartz
 * Selected Toolkits: [None]
 * Selected I/O Modules: [None]
 * Selected Navigation Modules: [None]
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --renderer html --style quartz --target-name rpd-html --compilation simple
 */
(function(n){var c=n.Kefir;"undefined"===typeof c&&"undefined"!==typeof require&&(c=require("../vendor/kefir.min.js"));if(!c)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var a=function(){function l(b){return function(){return b}}function t(){var b=c.emitter();b.map(function(b){return{rule:b,func:function(m){m.render(b.aliases,b.targets,b.config)}}}).scan(function(b,m){b&&I["network/add-patch"].offValue(b.func);I["network/add-patch"].onValue(m.func);return m},
null).last().onValue(function(b){I["network/add-patch"].offValue(b.func)});return b}function x(b,e){z(b);var m=new h(b,e||b);I["network/add-patch"].emit(m);return m}function h(b,e){this.id=K();this.name=b;this.def=e||{};var m=this,f={"patch/is-ready":[],"patch/open":["parent"],"patch/close":[],"patch/move-canvas":["position"],"patch/resize-canvas":["size"],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],"patch/add-node":["node"],
"patch/remove-node":["node"]};this.event=B(f);this.events=C(f,this.event,"patch",this);this.def.handle&&A(this.events,this.def.handle);this.renderQueue=c.emitter();f=c.combine([this.events],[this.renderQueue.scan(function(b,e){var u=e.alias,f=e.target,p=e.config,a=b[u];a||(a={},a.produce=S[u](m),a.handlers=[],b[u]=a);if(a.produce){var d=a.produce(f,p);d&&a.handlers.push("function"===typeof d?d:function(b){if(d[b.type])d[b.type](b)})}return b},{})]);f=f.bufferBy(this.renderQueue).take(1).flatten().concat(f);
f.onValue(function(b){var e=b[0];b=b[1];for(var m=Object.keys(b),u,f=0,a=m.length;f<a;f++){u=b[m[f]];u=u.handlers;for(var p=0,d=u.length;p<d;p++)u[p](aa(k(e),m[f]))}});this.projections=c.emitter();c.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(b){var e=b[0],u=b[1];b=b[2];for(var f,a=0;a<u.length;a++)f=e.addInlet(u[a].type,u[a].alias,u[a].def,u[a].render),f.event["inlet/update"].onValue(function(b){return function(e){b.receive(e)}}(u[a]));
for(a=0;a<b.length;a++)u=e.addOutlet(b[a].type,b[a].alias,b[a].def,b[a].render),b[a].event["outlet/update"].onValue(function(b){return function(e){b.send(e)}}(u));m.event["patch/project"].emit({node:e,target:e.patch});e.patch.event["patch/refer"].emit({node:e,target:m})});this.nodesToRemove=c.emitter();this.event["patch/is-ready"].emit()}function g(b,e,m,a,p){this.type=b||"core/basic";this.toolkit=w(b);this.id=K();this.patch=e;b={"node/turn-on":[],"node/is-ready":[],"node/process":["inlets","outlets"],
"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=B(b);this.events=C(b,this.event,"node",this);(b=L(E[this.type],this))||y(this,"node","Node type '"+this.type+"' is not registered!");this.def=f(Q,m,b);this.render=F(ba,a,O(P[this.type],this));p&&p(this);var d=this;this.def.handle&&A(this.events,this.def.handle);if(this.def.process){var h=this.def.process;m=c.combine([this.event["node/add-inlet"].flatMap(function(b){var e=
b.event["inlet/update"].map(function(e){return{inlet:b,value:e}});d.def.tune&&(e=d.def.tune.bind(d)(e));return e})],[this.event["node/add-outlet"].scan(function(b,e){b[e.alias]=e;return b},{})]);m=m.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(m);m=m.scan(function(b,e){var m=e[0].inlet,u=m.alias;b.inlets.prev[u]=b.inlets.cur[u];b.inlets.cur[u]=e[0].value;b.outlets=e[1];b.source=m;return b},{inlets:{prev:{},cur:{}},outlets:{}}).changes();m=m.filter(function(b){return!b.source.def.cold});
m.onValue(function(b){var e=h.bind(d)(b.inlets.cur,b.inlets.prev);d.event["node/process"].emit({inlets:b.inlets.cur,outlets:e});b=b.outlets;for(var m in e)b[m]&&(e[m]instanceof c.Stream?b[m].stream(e[m]):b[m].send(e[m]))})}if(this.def.inlets){this.inlets={};for(var k in this.def.inlets)m=this.def.inlets[k],m=this.addInlet(m.type,k,m),this.inlets[k]=m}if(this.def.outlets)for(k in this.outlets={},this.def.outlets)m=this.def.outlets[k],m=this.addOutlet(m.type,k,m),this.outlets[k]=m;this.def.prepare&&
this.def.prepare.bind(this)(this.inlets,this.outlets);this.event["node/is-ready"].emit()}function d(b,u,m,a,d){this.type=b||"core/any";this.toolkit=w(b);this.id=K();this.alias=m;this.node=u;(b=L(e[this.type],this))||y(this,"inlet","Channel type '"+this.type+"' is not registered!");this.def=f(p,a,b);this.alias||J(this,"inlet","Inlet should have an alias");this.value=c.pool();this.render=F(V,d,O(G[this.type],this));a={"inlet/update":["value"]};this.event=B(a);var k=this.event["inlet/update"];d=k.merge(this.value);
this.def.tune&&(d=this.def.tune.bind(this)(d));this.def.accept&&(d=d.flatten(function(b){if(this.def.accept(b))return[b];k.error({type:"inlet/error",system:!1,subject:this,message:void 0,silent:!0});return[]}.bind(this)));this.def.adapt&&(d=d.map(this.def.adapt));this.event["inlet/update"]=d.onValue(function(){});this.events=C(a,this.event,"inlet",this);this.def.handle&&A(this.events,this.def.handle)}function q(b,u,m,a,p){this.type=b||"core/any";this.toolkit=w(b);this.id=K();this.alias=m;this.node=
u;(b=L(e[this.type],this))||y(this,"outlet","Channel type '"+this.type+"' is not registered!");this.def=f(ca,a,b);this.alias||J(this,"outlet","Outlet should have an alias");this.value=c.pool();this.render=F(V,p,O(G[this.type],this));a={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=B(a);p=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=p.onValue(function(b){});this.events=C(a,this.event,"outlet",this);this.def.handle&&
A(this.events,this.def.handle);var d=this;c.combine([this.event["outlet/connect"]],[this.event["outlet/update"]]).onValue(function(b){d.value.plug(c.constant(b[1]))})}function n(b,e,m){this.id=K();this.name=m||"";this.outlet=b;this.inlet=e;this.value=c.emitter();var a=this;this.receiver=b.node.id!==e.node.id?function(b){a.pass(b)}:function(b){setTimeout(function(){a.pass(b)},0)};b={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=B(b);m=this.event["link/pass"].merge(this.value);
this.event["link/pass"]=m.onValue(function(b){});this.events=C(b,this.event,"link",this);this.enabled=c.merge([this.event["link/disable"].map(l(!1)),this.event["link/enable"].map(l(!0))]).toProperty(l(!0));this.event["link/pass"].filterBy(this.enabled).onValue(function(b){e.receive(b)});c.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(b){a.pass(b[1])})}function f(b,e,m){var a={};e=e||{};m=m||{};for(var f,p=0,d=b.length;p<d;p++)if(f=b[p],"*"!==f[0]){if(f in e||f in
m)a[f]=D(e[f])?e[f]:m[f]}else if(f=f.slice(1),f in e||f in m){a[f]={};for(var k=m[f]?Object.keys(m[f]):[],h=0,c=k.length;h<c;h++)a[f][k[h]]=m[f][k[h]];k=e[f]?Object.keys(e[f]):[];h=0;for(c=k.length;h<c;h++)a[f][k[h]]=e[f][k[h]]}return a}function k(b){for(var e={},m=Object.keys(b),a=0,f=m.length;a<f;a++)e[m[a]]=b[m[a]];return e}function z(b){return"object"===typeof b}function D(b){return"undefined"!==typeof b}function L(b,e){return b?"function"===typeof b?b(e):b:null}function O(b,e){if(!b)return{};
var m={},a;for(a in b)m[a]=L(b[a],e);return m}function F(b,e,m){if(!e)return m;var a={},p;for(p in m)a[p]=f(b,e[p],m[p]);for(p in e)a[p]||m[p]||(a[p]=e[p]);return a}function B(b){var e={};b=Object.keys(b);for(var a=0,f;a<b.length;a++)f=b[a],e[f]=c.emitter();return e}function R(b,e){if(0===e.length)return function(){return{type:b}};if(1===e.length)return function(a){var f={};f.type=b;f[e[0]]=a;return f};if(1<e.length)return function(e){e=k(e);e.type=b;return e}}function C(b,e,a,f){for(var p=c.pool(),
d=Object.keys(b),k=0;k<d.length;k++)p.plug(e[d[k]].map(R(d[k],b[d[k]])).map(function(b){b[a]=f;return b}));return p}function A(b,e){b.filter(function(b){return e[b.type]}).onValue(function(b){e[b.type](b)})}function J(b,e,a,f){U.plug(c.constantError({type:e+"/error",system:f||!1,subject:b,message:a}))}function y(b,e,a){J(b,e,a,!0)}function K(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function aa(b,e){var a=b.type;if("patch/add-node"===a||"node/process"===a)b.render=
b.node.render[e]||{};else if("node/add-inlet"===a||"inlet/update"===a)b.render=b.inlet.render[e]||{};else if("node/add-outlet"===a||"outlet/update"===a)b.render=b.outlet.render[e]||{};return b}function w(b){var e=b.indexOf("/");return 0<=e?b.substring(0,e):""}function v(b,e){E[b]=e||{}}function r(b,a){e[b]=a||{}}(function(){c.emitter=function(){var b,e=c.stream(function(e){b=e;return function(){b=void 0}});e.emit=function(e){b&&b.emit(e);return this};e.error=function(e){b&&b.error(e);return this};
e.end=function(){b&&b.end();return this};e.emitEvent=function(e){b&&b.emitEvent(e);return this};return e.setName("emitter")}})();var E={},Q="title *inlets *outlets prepare process tune *handle".split(" "),e={},p="label default hidden cold readonly allow accept adapt tune show *handle".split(" "),ca=["label","tune","show","*handle"],P={},ba=["prepare","size","first","always"],G={},V=["prepare","show","edit"],W={},M={},X={},Y={},S={},Z={"network/add-patch":["patch"]},I=B(Z),U=C(Z,I,"network",a);I["network/add-patch"].onValue(function(b){U.plug(b.events)});
var N;h.prototype.render=function(b,e,a){b=Array.isArray(b)?b:[b];e=Array.isArray(e)?e:[e];for(var f=0,p=b.length,d;f<p;f++)for(var k=0,h=e.length,c;k<h;k++)d=b[f],c=e[k],S[d]||y(this,"patch","Renderer '"+d+"' is not registered"),this.renderQueue.emit({alias:d,target:c,config:a});return this};h.prototype.addNode=function(b,e,a,f){var p=this,d=a?a:z(e)?e||{}:{},k=z(e)?void 0:e;k&&(d.title=k);e=e&&z(e)?a:f;return new g(b,this,d,e,function(b){p.events.plug(b.events);p.event["patch/add-node"].emit(b);
b.turnOn()})};h.prototype.removeNode=function(b){b.turnOff();this.event["patch/remove-node"].emit(b);this.events.unplug(b.events)};h.prototype.open=function(b){this.event["patch/open"].emit(b);return this};h.prototype.close=function(){this.event["patch/close"].emit();return this};h.prototype.inputs=function(b){this.event["patch/set-inputs"].emit(b);return this};h.prototype.outputs=function(b){this.event["patch/set-outputs"].emit(b);return this};h.prototype.project=function(b){this.projections.emit(b);
return this};h.prototype.moveCanvas=function(b,e){this.event["patch/move-canvas"].emit([b,e]);return this};h.prototype.resizeCanvas=function(b,e){this.event["patch/resize-canvas"].emit([b,e]);return this};g.prototype.turnOn=function(){this.event["node/turn-on"].emit();return this};g.prototype.turnOff=function(){this.event["node/turn-off"].emit();return this};g.prototype.addInlet=function(b,e,a,f,p){var k=f?f:z(a)?a||{}:{},h=z(a)?void 0:a;h&&(k.label=h);a=a&&z(a)?f:p;b=new d(b,this,e,k,a);this.events.plug(b.events);
this.event["node/add-inlet"].emit(b);b.toDefault();return b};g.prototype.addOutlet=function(b,e,a,f,p){var d=f?f:z(a)?a||{}:{},k=z(a)?void 0:a;k&&(d.label=k);a=a&&z(a)?f:p;b=new q(b,this,e,d,a);this.events.plug(b.events);this.event["node/add-outlet"].emit(b);b.toDefault();return b};g.prototype.removeInlet=function(b){this.event["node/remove-inlet"].emit(b);this.events.unplug(b.events);return this};g.prototype.removeOutlet=function(b){this.event["node/remove-outlet"].emit(b);this.events.unplug(b.events);
return this};g.prototype.move=function(b,e){this.event["node/move"].emit([b,e]);return this};d.prototype.receive=function(b){this.value.plug(c.constant(b));return this};d.prototype.stream=function(b){this.value.plug(b);return this};d.prototype.toDefault=function(){D(this.def.default)&&(this.def.default instanceof c.Stream?this.stream(this.def.default):this.receive(this.def.default));return this};d.prototype.allows=function(b){if("core/any"===this.type||b.type===this.type)return!0;if(!this.def.allow&&
b.type!==this.type)return!1;if(this.def.allow){var e=!1;this.def.allow.forEach(function(a){b.type===a&&(e=!0)});return e}return!0};q.prototype.connect=function(b){b.allows(this)||J(this,"outlet","Outlet of type '"+this.type+"' is not allowed to connect to inlet of type '"+b.type+"'");var e=new n(this,b);this.events.plug(e.events);this.value.onValue(e.receiver);this.event["outlet/connect"].emit({link:e,inlet:b});return e};q.prototype.disconnect=function(b){this.event["outlet/disconnect"].emit(b);this.value.offValue(b.receiver);
this.events.unplug(b.events);return this};q.prototype.send=function(b){this.value.plug(c.constant(b));return this};q.prototype.stream=function(b){this.value.plug(b);return this};q.prototype.toDefault=function(){D(this.def.default)&&(this.def.default instanceof c.Stream?this.stream(this.def.default):this.send(this.def.default));return this};n.prototype.pass=function(b){this.value.emit(b);return this};n.prototype.enable=function(){this.event["link/enable"].emit();return this};n.prototype.disable=function(){this.event["link/disable"].emit();
return this};n.prototype.disconnect=function(){this.outlet.disconnect(this);return this};v("core/basic",{});v("core/reference",{});r("core/any",{});var H={patch:function(b){return"[ Patch"+(b.name?" '"+b.name+"'":" <Unnamed>")+" ]"},node:function(b){return"[ Node ("+b.type+")"+(b.def?b.def.title?" '"+b.def.title+"'":" <Untitled>":" <Unprepared>")+" #"+b.id+" ]"},outlet:function(b){return"[ Outlet ("+b.type+")"+(b.alias?" '"+b.alias+"'":" <Unaliased>")+(b.def?b.def.label?" '"+b.def.label+"'":" <Unlabeled>":
" <Unprepared>")+" #"+b.id+" ]"},inlet:function(b){return"[ Inlet ("+b.type+")"+(b.alias?" '"+b.alias+"'":" <Unaliased>")+(b.def?b.def.label?" '"+b.def.label+"'":" <Unlabeled>":" <Unprepared>")+" #"+b.id+(b.def.hidden?" (hidden)":"")+(b.def.cold?" (cold)":"")+" ]"},link:function(b){return"[ Link ("+b.type+") '"+b.name+"' #"+b.id+" "+H.outlet(b.outlet)+" -> "+H.inlet(b.inlet)+" ]"}};return{VERSION:"v2.0.0",_:{Patch:h,Node:g,Inlet:d,Outlet:q,Link:n},unit:l,not:function(b){return!b},event:I,events:U,
addPatch:function(b,e,a){return x(b,e).open(a)},addClosedPatch:x,renderNext:function(b,e,a){N||(N=t());N.emit({aliases:b,targets:e,config:a})},stopRendering:function(){N&&(N.end(),N=null)},nodetype:v,channeltype:r,nodedescription:function(b,e){W[b]=e},renderer:function(b,e){S[b]=e},styles:M,style:function(b,e,a){M[b]||(M[b]={});M[b][e]=a},noderenderer:function(b,e,a){E[b]||y(null,"network","Node type '"+b+"' is not registered");P[b]||(P[b]={});P[b][e]=a},channelrenderer:function(b,a,f){e[b]||y(null,
"network","Channel type '"+b+"' is not registered");G[b]||(G[b]={});G[b][a]=f},toolkiticon:function(b,e){Y[b]=e},nodetypeicon:function(b,e){X[b]=e},"import":{},"export":{},allNodeTypes:E,allChannelTypes:e,allNodeRenderers:P,allChannelRenderers:G,allNodeDescriptions:W,allNodeTypeIcons:X,allToolkitIcons:Y,getStyle:function(b,e){b||y(null,"network","Unknown style requested: '"+b+"'");M[b]||y(null,"network","Style '"+b+"' is not registered");var a=M[b][e];a||y(null,"network","Style '"+b+"' has no definition for '"+
e+"' renderer");return a},reportError:J,reportSystemError:y,short_uid:K,stringify:H,autoStringify:function(b){return b instanceof h?H.patch(b):b instanceof g?H.node(b):b instanceof d?H.inlet(b):b instanceof q?H.outlet(b):b instanceof n?H.link(b):"<?> "+b}}}();"function"===typeof define&&define.amd?(define([],function(){return a}),n.Rpd=a):"object"===typeof module&&"object"===typeof exports?(module.exports=a,a.Rpd=a):n.Rpd=a})(this);var d3_tiny=function(){function n(a,c,t){for(var n="function"===typeof c?c:function(){return c},h=a.selection,g=0,d=h.length;g<d;g++)t(h[g],n.bind(h[g])(g));return a}function c(a,c,t){c=c||document;selection="string"===typeof a?t?Array.prototype.slice.call(c.querySelectorAll(a),0):[c.querySelector(a)]:a instanceof Node?[a]:Array.isArray(a)?a:[a];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}c.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};c.prototype.attr=function(a,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0].getAttribute(a):n(this,c,function(c,l){c.setAttributeNS(null,a,l)})};c.prototype.property=function(a,c){return"undefined"===typeof c&&1===this.selection.length?this.selection[0][a]:n(this,c,function(c,l){c[a]=l})};c.prototype.style=function(a,c){"-"===a[0]&&(a=a.slice(1));a=a.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()});return n(this,
c,function(c,l){c.style[a]=l})};c.prototype.text=function(a){return"undefined"===typeof a&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:n(this,a,function(a,c){a.innerText=a.textContent=c})};c.prototype.classed=function(a,c){return"object"===typeof a?n(this,Object.keys(a),function(c,l){for(var h=0,g=l.length;h<g;h++)c.classList.toggle(l[h],a[l[h]])}):n(this,c,function(c,l){c.classList.toggle(a,l)})};c.prototype.select=function(a){return new c(a,this.selection[0])};
c.prototype.selectAll=function(a){return new c(a,this.selection[0],!0)};c.prototype.append=function(a){var l=[];n(this,"string"===typeof a?document.createElementNS(this.namespace,a):a,function(a,c){a.appendChild(c);l.push(c)});return new c(l)};c.prototype.remove=function(){return n(this,function(){return null},function(a){a.parentElement.removeChild(a)})};c.prototype.node=function(a){return this.selection[a||0]};c.prototype.on=function(a,c){return n(this,function(){return c},function(c,l){c.addEventListener(a,
l)})};c.prototype.data=function(a){return a?n(this,a,function(a,c){a.__data__=c}):this.node().__data__};c.prototype.call=function(a){a(this);return this};return{ns:{prefix:{svg:"https://www.w3.org/2000/svg",html:"https://www.w3.org/1999/xhtml"}},select:function(a,l){return new c(a,l)},selectAll:function(a,l){return new c(a,l,!0)}}}();Rpd.Render=function(){function n(a){this.nodeRects=[];this.edgePadding=a.edgePadding||{horizontal:30,vertical:20};this.boxPadding=a.boxPadding||{horizontal:20,vertical:30}}function c(a,d){this.canvas=a;this.style=d}function a(a,d){this.link=a;this.style=d;this.element=this.styledLink=null}function l(){this.vlinks=[]}function t(a){a.stopPropagation();return a}function x(a){return{x:a.clientX,y:a.clientY}}function h(a,d,c,h){Kefir.fromEvents(a,"click").map(t).map(g(h||!1)).scan(Rpd.not).onValue(function(a){a?
d():c()})}var g=Rpd.unit,d=d3_tiny||d;n.DEFAULT_LIMITS=[1E3,1E3];n.prototype.nextPosition=function(a,d,c){c=c||n.DEFAULT_LIMITS;a=this.nodeRects;var h=this.boxPadding,g=this.edgePadding,l=d.width;d=d.height;var q=a.length?a[a.length-1]:null,q={x:q?q.x:g.horizontal,y:q?q.y+q.height+h.vertical:g.vertical,width:l,height:d};q.y+d+g.vertical>c.height&&(q.x=q.x+l+h.horizontal,q.y=g.vertical);a.push(q);return{x:q.x,y:q.y}};c.prototype.add=function(a,d){var c=this.canvas,h=this.style,g=d.start,q=d.end,l=
d.drag;Kefir.fromEvents(a.node(),"mousedown").map(x).map(h.getLocalPos).flatMap(function(d){var k=g(),l=d.x-k.x,n=d.y-k.y;d=Kefir.fromEvents(c.node(),"mousemove").map(t).takeUntilBy(Kefir.merge([Kefir.fromEvents(c.node(),"mouseup"),Kefir.fromEvents(a.node(),"mouseup")])).map(x).map(h.getLocalPos).map(function(a){return{x:a.x-l,y:a.y-n}}).toProperty(function(){return k});d.last().onValue(q);return d}).onValue(l)};a.prototype.construct=function(a){if(this.styledLink)throw Error("VLink is already constructed");
this.styledLink=a=this.style.createLink(this.link);this.element=d.select(a.element);return this};a.prototype.rotate=function(a,d,c,h){var g=this.style;a=g.getLocalPos({x:a,y:d});c=g.getLocalPos({x:c,y:h});this.styledLink.rotate(a.x,a.y,c.x,c.y);return this};a.prototype.rotateI=function(a,d,c){var h=this.style.getInletPos(c);return this.rotate(a,d,h.x,c.y)};a.prototype.rotateO=function(a,d,c){a=this.style.getOutletPos(a);return this.rotate(a.x,a.y,d,c)};a.prototype.rotateOI=function(a,d){var c=this.style,
h=c.getOutletPos(a),c=c.getInletPos(d);return this.rotate(h.x,h.y,c.x,c.y)};a.prototype.update=function(){if(this.link){var a=this.link;this.rotateOI(a.outlet,a.inlet);return this}};a.prototype.appendTo=function(a){a.append(this.element.node());return this};a.prototype.removeFrom=function(a){this.element.remove();return this};a.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&this.styledLink.noPointerEvents();return this};a.prototype.listenForClicks=function(){var a=this.link;
h(this.element.node(),function(){a.enable()},function(){a.disable()});return this};a.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};a.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};a.prototype.get=function(){return this.link};a.prototype.getElement=function(){return this.element.node()};l.prototype.clear=function(){this.vlinks=[]};l.prototype.add=function(a){this.vlinks.push(a);return a};l.prototype.remove=function(a){this.vlinks=this.vlinks.filter(function(d){return d!==
a})};l.prototype.forEach=function(a){this.vlinks.forEach(a)};l.prototype.updateAll=function(){this.forEach(function(a){a.update()})};l.prototype.count=function(){return this.vlinks.length};l.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var q=function(){var a={};return function(d,c,h){c.classed("rpd-error",!0);a[d]&&clearTimeout(a[d]);a[d]=setTimeout(function(){c.classed("rpd-error",!1);a[d]=null},h||1)}}(),T=function(){var a={};return function(d,c,h){c.classed("rpd-stale",
!1);c.classed("rpd-fresh",!0);a[d]&&clearTimeout(a[d]);a[d]=setTimeout(function(){c.classed("rpd-fresh",!1);c.classed("rpd-stale",!0);a[d]=null},h||1)}}();return{Placing:n,DragAndDrop:c,VLink:a,VLinks:l,mergeConfig:function(a,d){if(a){var c={};Object.keys(d).forEach(function(a){c[a]=d[a]});Object.keys(a).forEach(function(d){c[d]=a[d]});return c}return d},preventDefault:function(a){a.preventDefault();return a},stopPropagation:t,extractPos:x,addTarget:function(a){return function(d){return{pos:d,target:a}}},
addClickSwitch:h,addValueErrorEffect:q,addValueUpdateEffect:T,subscribeUpdates:function(a,d){d&&Object.keys(d).forEach(function(c){(function(d,c){a.event["node/add-inlet"].filter(function(a){return a.alias===c}).onValue(function(c){a.event["node/is-ready"].onValue(function(){d.default&&c.receive("function"===typeof d.default?d.default():d.default);if(d.valueOut)d.valueOut.onValue(function(a){c.receive(a)})})})})(d[c],c)})},reportErrorsToConsole:function(a){Rpd.events.onError(function(d){a.logErrors&&
(d.silent||(d.system?console.error(Error(d.type+" \u2014 "+d.message+". Subject: "+Rpd.autoStringify(d.subject))):console.log("Error:",d.type,"\u2014",d.message+". ","Subject: "+Rpd.autoStringify(d.subject),d.subject)))})}}}();Rpd.style("quartz","html",function(n){function c(a){a=a.getBoundingClientRect();return{x:a.left,y:a.top}}var a=a||d3_tiny,l,t={},x={};return{edgePadding:{horizontal:30,vertical:20},boxPadding:{horizontal:20,vertical:30},createCanvas:function(c,g){return{element:a.select(document.createElement("div")).classed("rpd-patch",!0).node()}},createNode:function(c,g,d,q){var l=a.select(document.createElement("table")).attr("class","rpd-node");l.append("thead").attr("class","rpd-title").classed("rpd-drag-handle",
!0).call(function(a){a.append("tr").attr("class","rpd-remove-button").append("th").text("x")}).call(function(a){a.append("tr").attr("class","rpd-header").append("th").attr("colspan",3).call(function(a){n.showTypes&&a.append("span").attr("class","rpd-type").text(c.type);q&&a.append("span").attr("class","rpd-icon").text(q);a.append("span").attr("class","rpd-name").text(c.def.title||c.type);a.attr("title",d?d+" ("+c.type+")":c.type)})});l.append("tbody").attr("class","rpd-content").call(function(a){a.append("tr").call(function(a){a.append("td").attr("class",
"rpd-inlets").append("table").append("tbody").append("div").attr("class","rpd-inlets-target")}).call(function(a){a.append("td").attr("class","rpd-body").append("table").append("tbody").append("tr").append("td").append("div").attr("class","rpd-process-target")}).call(function(a){a.append("td").attr("class","rpd-outlets").append("table").append("tbody").append("div").attr("class","rpd-outlets-target")})});return{element:l.node(),size:g.size?{width:g.size.width||70,height:g.size.height||30}:{width:70,
height:30}}},createInlet:function(c,g){var d=a.select(document.createElement("tr")).attr("class","rpd-inlet").call(function(a){a.append("td").attr("class","rpd-connector");a.append("td").attr("class","rpd-value-holder").append("span").attr("class","rpd-value");a.append("td").attr("class","rpd-name").text(c.def.label||c.alias);n.showTypes&&a.append("td").attr("class","rpd-type").text(c.type)});t[c.id]=d.select(".rpd-connector");return{element:d.node()}},createOutlet:function(c,g){var d=a.select(document.createElement("tr")).attr("class",
"rpd-outlet").call(function(a){a.append("td").attr("class","rpd-connector");a.append("td").attr("class","rpd-value");n.showTypes&&a.append("td").attr("class","rpd-type").text(c.type);a.append("td").attr("class","rpd-name").text(c.def.label||c.alias)});x[c.id]=d.select(".rpd-connector");return{element:d.node()}},createLink:function(c){var g=a.select(document.createElement("span")).attr("class","rpd-link").style("position","absolute").style("transform-origin","left top").style("-webkit-transform-origin",
"left top");return{element:g.node(),rotate:function(a,c,h,f){var l=Math.sqrt((a-h)*(a-h)+(c-f)*(c-f));h=Math.atan2(f-c,h-a);g.style("left",a+"px").style("top",c+"px").style("width",Math.floor(l)+"px").style("transform","rotateZ("+h+"rad)").style("-webkit-transform","rotateZ("+h+"rad)")}}},getInletPos:function(a){a=c(t[a.id].node());return{x:a.x,y:a.y-1}},getOutletPos:function(a){a=c(x[a.id].node());return{x:a.x,y:a.y-1}},getLocalPos:function(a){if(!l)return a;var g=c(l.node());return{x:a.x-g.x,y:a.y-
g.y-1}},onPatchSwitch:function(c,g){l=a.select(g)}}});(function(){function n(a){return function(n,t){var w=L(t,x);g.reportErrorsToConsole(w);var v=Rpd.getStyle(w.style,"html")(w);n=h.select(n).classed("rpd-network",!0).classed("rpd-full-page",w.fullPage);var r,E,Q;return{"patch/is-ready":function(e){var p=h.select(document.documentElement);r=h.select(v.createCanvas(a,n).element).classed("rpd-canvas",!0);w.fullPage&&r.style("height",p.property("clientHeight")+"px");w.fullPage&&c(window,document,n,r);r.classed("rpd-style-"+w.style,!0).classed("rpd-values-"+
(w.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",w.showBoxes);d.patches[a.id]=r.data({patch:e.patch});d.patchToPlacing[a.id]=new g.Placing(v);d.patchToLinks[a.id]=new D;E=new k(r,v,w);w.nodeMovingAllowed&&(Q=new g.DragAndDrop(r,v));Kefir.fromEvents(r.node(),"selectstart").onValue(O)},"patch/open":function(a){(w.closeParent||w.fullPage)&&a.parent&&a.parent.close();q=a.patch;var c=d.patches[a.patch.id];n.append(c.node());d.patchToLinks[a.patch.id].updateAll();if(v.onPatchSwitch)v.onPatchSwitch(q,
c.node())},"patch/close":function(a){q=null;r.remove()},"patch/refer":function(e){var c=d.nodes[e.node.id];c.select(".rpd-node").classed("rpd-patch-reference",!0);c.data().processTarget.text("["+(e.target.name||e.target.id)+"]");Kefir.fromEvents(c.data().processTarget.node(),"click").onValue(function(a,e){return function(){e.open(a)}}(a,e.target))},"patch/move-canvas":function(a){r.style("left",a.position[0]+"px");r.style("top",a.position[1]+"px")},"patch/resize-canvas":function(a){r.style("width",
a.size[0]+"px");r.style("height",a.size[1]+"px")},"patch/add-node":function(a){var c=a.node,g=a.patch,l=a.render,r=h.select(document.createElement("div")).attr("class","rpd-node-box"),k=v.createNode(c,l,T[c.type],f[c.type]),n=r.append(k.element);n.classed("rpd-"+c.type.slice(0,c.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+c.type.replace("/","-"),!0);r.style("z-index",0);d.nodes[c.id]=r.data({inletsTarget:n.select(".rpd-inlets-target"),outletsTarget:n.select(".rpd-outlets-target"),processTarget:n.select(".rpd-process-target"),
pos:{x:0,y:0}});var y=new D;d.nodeToLinks[c.id]=y;if(w.nodeMovingAllowed){var t=n.select(".rpd-drag-handle");t.empty()||Q.add(t,{start:function(){r.classed("rpd-dragging",!0);r.style("z-index",1);return r.data().pos},drag:function(a){r.style("left",a.x+"px");r.style("top",a.y+"px");y.forEach(function(a){a.element.style("z-index",3);a.update()})},end:function(a){c.move(a.x,a.y);r.classed("rpd-dragging",!1);r.style("z-index",0);y.forEach(function(a){a.element.style("z-index",2)})}})}l.prepare&&l.prepare.bind(c)(d.patches[g.id].node(),
d.patches[q.id].node());l.first&&J(c,l.first.bind(c)(n.select(".rpd-process-target").node()));if(l.always)c.event["node/process"].throttle(100).onValue(function(){y.updateAll()});l=d.patches[q.id];k=k.size;nodePos=d.patchToPlacing[a.patch.id].nextPosition(c,k,{width:l.node().offsetWidth,height:l.node().offsetHeight});n.select(".rpd-body").style("min-width",Math.floor(k.width)+"px");n.select(".rpd-body").style("height",Math.floor(k.height)+"px");c.move(nodePos.x,nodePos.y);a=n.select(".rpd-remove-button");
if(!a.empty())Kefir.fromEvents(a.node(),"click").map(F).onValue(function(){g.removeNode(c)});d.patches[g.id].append(r.node())},"patch/remove-node":function(a){a=a.node;var c=d.nodes[a.id];d.nodeToLinks[a.id].forEach(function(a){a.get().disconnect()});c.remove();if(v.onNodeRemove)v.onNodeRemove(a);d.nodes[a.id]=null;d.nodeToLinks[a.id]=null},"node/move":function(a){var c=d.nodes[a.node.id];a=a.position;c.style("left",Math.floor(a[0])+"px");c.style("top",Math.floor(a[1])+"px");c.data().pos={x:a[0],
y:a[1]}},"node/process":function(a){var c=a.node,h=a.render;if(h.always){var f=d.nodes[c.id].data().processTarget.node();h.always.bind(c)(f,a.inlets,a.outlets)}},"node/add-inlet":function(a){var c=a.inlet;if(!c.def.hidden){var f=d.nodes[a.node.id].data().inletsTarget;a=a.render;var g=h.select(v.createInlet(c,a).element);g.classed("rpd-"+c.type.replace("/","-"),!0);g.classed({"rpd-stale":!0,"rpd-readonly":c.def.readonly||!1,"rpd-cold":c.def.cold||!1});var n=null;!c.def.readonly&&a.edit&&(n=new l(c,
a,r,g.select(".rpd-value-holder"),g.select(".rpd-value"),h.select(document.createElement("div"))),g.select(".rpd-value-holder").append(n.editorElm.node()));d.inlets[c.id]=g.data({connector:g.select(".rpd-connector"),value:g.select(".rpd-value"),vlinks:new D,editor:n});c.event["inlet/update"].onError(function(){C(c.id,g,w.effectTime)});E.subscribeInlet(c,g.select(".rpd-connector"));f.append(g.node())}},"node/add-outlet":function(a){var c=a.outlet,f=d.nodes[a.node.id].data().outletsTarget;a=h.select(v.createOutlet(c,
a.render).element);a.classed("rpd-"+c.type.replace("/","-"),!0);a.classed("rpd-stale",!0);d.outlets[c.id]=a.data({connector:a.select(".rpd-connector"),value:a.select(".rpd-value"),vlinks:new D});E.subscribeOutlet(c,a.select(".rpd-connector"));f.append(a.node())},"node/remove-inlet":function(a){a=a.inlet;d.inlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});d.inlets[a.id].remove();if(v.onInletRemove)v.onInletRemove(a);d.inlets[a.id]=null},"node/remove-outlet":function(a){a=a.outlet;
d.outlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});d.outlets[a.id].remove();if(v.onOutletRemove)v.onOutletRemove(a);d.outlets[a.id]=null},"inlet/update":function(a){var c=a.inlet;if(!c.def.hidden){var f=a.render,h=d.inlets[c.id],g=h.data().value;if(!g.empty()){var l=c.def.show?c.def.show(a.value):a.value;f.show?f.show.bind(c)(g.node(),a.value,l):g.text(l)}A(c.id,h,w.effectTime)}},"outlet/update":function(a){var c=a.outlet,f=a.render,h=d.outlets[c.id],g=h.data().value;if(!g.empty()){var l=
c.def.show?c.def.show(a.value):a.value;f.show?f.show.bind(c)(g.node(),a.value,l):g.text(l)}A(c.id,h,w.effectTime)},"outlet/connect":function(c){c=c.link;var f=c.outlet,g=c.inlet,l=d.inlets[g.id],n=d.outlets[f.id].data(),l=l.data();if(!w.inletAcceptsMultipleLinks&&1===l.vlinks.count())throw Error("Inlet is already connected to a link");l.editor&&l.editor.disable();var k=new z(c,v);k.construct(w.linkWidth).rotateOI(f,g);h.select(k.getElement()).style("z-index",2).classed("rpd-"+g.type.replace("/","-"),
!0).classed("rpd-"+f.type.replace("/","-"),!0);d.links[c.id]=k;n.vlinks.add(k);l.vlinks.add(k);d.nodeToLinks[f.node.id].add(k);f.node.id!==g.node.id&&d.nodeToLinks[g.node.id].add(k);d.patchToLinks[a.id].add(k);k.listenForClicks();k.appendTo(r)},"outlet/disconnect":function(c){c=c.link;var f=d.links[c.id],h=c.outlet,g=c.inlet,l=d.outlets[h.id].data(),k=d.inlets[g.id].data();d.links[c.id]=null;l.vlinks.remove(f);k.vlinks.remove(f);d.nodeToLinks[h.node.id].remove(f);h.node.id!==g.node.id&&d.nodeToLinks[g.node.id].remove(f);
d.patchToLinks[a.id].remove(f);f.removeFrom(r)},"link/enable":function(a){var c=d.inlets[a.link.inlet.id].data();c.editor&&c.editor.disable();d.links[a.link.id].enable()},"link/disable":function(a){d.links[a.link.id].disable()}}}}function c(a,c,d,f){Kefir.fromEvents(a,"resize").map(function(){return a.innerHeight||c.documentElement.clientHeight||c.body.clientHeight}).onValue(function(a){d.style("height",a+"px");f.style("height",a+"px")});d.data({subscribedToResize:!0})}function a(a,c){return Kefir.merge([a.map(t(!0)),
c.map(t(!1))]).toProperty(t(!1))}function l(a,c,f,h,g,l){var k=Kefir.emitter(),n=Kefir.emitter();this.disableEditor=n;this.editorElm=l;this.valueElm=g;l.classed("rpd-value-editor",!0);c.edit.bind(a)(l.node(),a,k).onValue(function(c){a.receive(c)});Kefir.combine([Kefir.merge([Kefir.fromEvents(h.node(),"click").map(F).map(t(!0)),Kefir.fromEvents(f.node(),"click").merge(n).map(t(!1))]).toProperty(t(!1)).skipDuplicates()],[a.event["inlet/update"]]).map(function(a){return{lastValue:a[1],startEditing:a[0],
cancelEditing:!a[0]}}).onValue(function(c){if(c.startEditing){var f=d.inlets[a.id].data();f.link&&f.link.disable();k.emit(c.lastValue);h.classed("rpd-editor-enabled",!0)}else c.cancelEditing&&(g.classed("rpd-edited",!0),h.classed("rpd-editor-enabled",!1))});h.classed("rpd-editor-disabled",!0)}var t=Rpd.unit,x={style:"quartz",fullPage:!1,valuesOnHover:!1,showTypes:!1,showBoxes:!1,nodeMovingAllowed:!0,inletAcceptsMultipleLinks:!1,closeParent:!1,logErrors:!0,effectTime:1E3},h=h||d3_tiny,g=Rpd.Render,
d={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},q,T=Rpd.allNodeDescriptions,f=Rpd.allNodeTypeIcons,k=function(){function c(a){return d.inlets[a.id].data().vlinks}function f(a){return function(){return 0<c(a).count()}}function g(a){1===a.count()&&(a=a.getLast().link,a.outlet.disconnect(a))}function l(a,c){a.forEach(function(a){a.link.outlet.id===c.id&&c.disconnect(a.link)})}function k(c,d,f){this.canvas=c;this.style=d;this.config=f;this.canvasClicks=
Kefir.fromEvents(this.canvas.node(),"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=a(this.startLink,this.finishLink)}k.prototype.subscribeOutlet=function(d,f){var k=this.canvas,e=this.style,n=this.config,q=this.canvasClicks,v=this.outletClicks,x=this.inletClicks,G=this.startLink,C=this.finishLink,D=this.doingLink;v.plug(Kefir.fromEvents(f.node(),"click").map(B).map(R(d)));Kefir.fromEvents(f.node(),
"click").map(F).filterBy(a(v,D)).map(B).onValue(function(a){G.emit();var f=(new z(null,e)).construct(n.linkWidth).rotateO(d,a.x,a.y).noPointerEvents().appendTo(k);h.select(f.getElement()).style("z-index",2).classed("rpd-"+d.type.replace("/","-"),!0);Kefir.fromEvents(k.node(),"mousemove").takeUntilBy(Kefir.merge([x,v.map(t(!1)),q.map(t(!1))]).take(1).onValue(function(a){if(a){a=a.target;var e=c(a);n.inletAcceptsMultipleLinks?l(e,d):g(e);d.connect(a)}})).map(B).onValue(function(a){f.rotateO(d,a.x,a.y)}).onEnd(function(){f.removeFrom(k);
C.emit()})})};k.prototype.subscribeInlet=function(d,k){var n=this.canvas,e=this.style,p=this.config,q=this.canvasClicks,v=this.outletClicks,x=this.inletClicks,C=this.startLink,D=this.finishLink,A=this.doingLink;x.plug(Kefir.fromEvents(k.node(),"click").map(B).map(R(d)));Kefir.fromEvents(k.node(),"click").map(F).filterBy(a(x,A)).filter(f(d)).onValue(function(a){var f=c(d).getLast().link,k=f.outlet;k.disconnect(f);C.emit();var A=(new z(null,e)).construct(p.linkWidth).rotateO(k,a.x,a.y).noPointerEvents().appendTo(n);
h.select(A.getElement()).style("z-index",2).classed("rpd-"+d.type.replace("/","-"),!0).classed("rpd-"+k.type.replace("/","-"),!0);Kefir.fromEvents(n.node(),"mousemove").takeUntilBy(Kefir.merge([x,v.map(t(!1)),q.map(t(!1))]).take(1).onValue(function(a){if(a){a=a.target;var d=c(a);p.inletAcceptsMultipleLinks?l(d,k):g(d);k.connect(a)}})).map(B).onValue(function(a){A.rotateO(k,a.x,a.y)}).onEnd(function(){A.removeFrom(n);D.emit()})})};return k}();l.prototype.disable=function(){this.valueElm.classed("rpd-edited",
!1);this.disableEditor.emit()};var z=g.VLink,D=g.VLinks,L=g.mergeConfig,O=g.preventDefault,F=g.stopPropagation,B=g.extractPos,R=g.addTarget,C=g.addValueErrorEffect,A=g.addValueUpdateEffect,J=g.subscribeUpdates;Rpd.HtmlRenderer=n;Rpd.renderer("html",n)})();
