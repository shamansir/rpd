/* RPD v0.1.0
 https://shamansir.github.io/rpd
 LICENSE: MIT (c) 2015 Anton Kotenko <shaman.sir@gmail.com> */

var Rpd=function(){function a(b){this.name=b;this.targets=Kefir.emitter();this.renderers=Kefir.emitter();b={"model/new":function(b){return{model:b}},"node/add":function(b){return{node:b}},"node/remove":function(b){return{node:b}}};this.event=G(b);this.events=I(b,this.event);Kefir.combine([this.events,this.targets.scan(H),this.renderers.scan(H)]).onValue(function(b){var c=b[0],a=b[2];K(b[1],function(b){K(a,function(a){a(b,c)})})});this.event["model/new"].emit(this)}function g(b,c){this.type=b||"core/empty";
this.id=C();var a=u(t[this.type]);a||D("Node type "+this.type+" is not registered!");this.def=a;this.name=c||a.name||"Unnamed";this.def=a;this.render=M(f[this.type]);var e=this,a={"node/turn-on":function(b){return{node:e}},"node/ready":function(b){return{node:e}},"node/process":function(b){return{inlets:b[0],outlets:b[1],node:e}},"node/turn-off":function(b){return{node:e}},"inlet/add":function(b){return{inlet:b}},"inlet/remove":function(b){return{inlet:b}},"outlet/add":function(b){return{outlet:b}},
"outlet/remove":function(b){return{outlet:b}}};this.event=G(a);this.events=I(a,this.event);S[T]?S[T].addNode(this):D("No model started!");if(this.def.handle)this.events.onValue(function(b){if(e.def.handle[b.type])e.def.handle[b.type](b)});if(this.def.process){var d=this.def.process,e=this;Kefir.combine([this.event["inlet/add"].flatMap(function(b){var a=b.event["inlet/update"].map(function(a){return{inlet:b,alias:b.alias,value:a}});e.def.tune&&(a=e.def.tune(a));return a}).scan(function(b,a){var c=
a.alias,F=a.inlet,N,R;if(b)return N=b.prev,R=b.cur,N[c]=R[c],R[c]=a.value,b.source=F,b;N={};R={};R[c]=a.value;return{prev:N,cur:R,source:F}},null).filter(function(b){return!(b&&b.source.cold)}),this.event["outlet/add"].scan(function(b,a){b=b||{};b[a.alias]=a;return b},null)]).onValue(function(b){var a=b[0]||{prev:{},cur:{}};b=b[1]||{};var c=d(a.cur,a.prev);e.event["node/process"].emit([a.cur,c,a.prev]);for(var F in c)b[F]&&b[F].send(c[F])})}if(this.def.inlets){this.inlets={};for(var l in this.def.inlets)a=
this.def.inlets[l],a=this.addInlet(a.type,l,a.name,a.default,a.hidden,a.readonly,a.cold),this.inlets[l]=a}if(this.def.outlets)for(l in this.outlets={},this.def.outlets)a=this.def.outlets[l],a=this.addOutlet(a.type,l,a.name,a.default),this.outlets[l]=a;this.def.prepare&&this.def.prepare(this.inlets,this.outlets);this.event["node/ready"].emit(this)}function c(b,a,c,e,f,h,q,g){this.type=b||"core/number";this.id=C();var k=u(l[this.type]);k||D("Inlet type "+this.type+" is not registered!");this.def=k;
(this.alias=c||e||k.alias)||D("Inlet should have either alias or name");this.name=e||this.alias||k.name||"Unnamed";this.node=a;this.hidden=h||!1;this.readonly=O(q||k.readonly)?q||k.readonly:!0;this.cold=g||!1;this.default=O(f)?f:k.default;this.value=Kefir.bus();this.render=M(d[this.type]);var p=this;b={"inlet/update":function(b){return{inlet:p,value:b}}};this.event=G(b);var N=this.event["inlet/update"];a=N.merge(this.value);k.tune&&(a=k.tune(a));k.accept&&(a=a.flatten(function(b){if(k.accept(b))return[b];
N.error();return[]}));k.adapt&&(a=a.map(k.adapt));this.event["inlet/update"]=a.onValue(function(){});this.events=I(b,this.event)}function h(b,a,c,e,f){this.type=b||"core/bool";this.id=C();(b=u(l[this.type]))||D("Outlet type "+this.type+" is not registered!");this.def=b;(this.alias=c||e||b.alias)||D("Outlet should have either alias or name");this.name=e||this.alias||b.name||"Unnamed";this.node=a;this.default=O(f)?f:b.default;this.value=Kefir.bus();this.render=M(d[this.type]);var h=this;a={"outlet/update":function(b){return{outlet:h,
value:b}},"outlet/connect":function(b){return{outlet:h,link:b}},"outlet/disconnect":function(b){return{outlet:h,link:b}}};this.event=G(a);this.event["outlet/update"]=this.event["outlet/update"].merge(this.value).onValue(function(){});this.events=I(a,this.event);Kefir.sampledBy([this.event["outlet/update"]],[this.event["outlet/connect"]]).onValue(function(b){h.value.emit(b[0])})}function y(b,a,c,l,d){this.type=b||"core/pass";this.id=C();(b=u(e[this.type]))||D("Link type "+this.type+" is not registered!");
this.def=b;this.name=d||b.name||"";this.outlet=a;this.inlet=c;this.adapter=l||b.adapt||void 0;var f=this;this.receiver=a.node.id!==c.node.id?function(b){return function(a){b.pass(a)}}(f):function(b){setTimeout(function(){f.pass(b)},0)};a={"link/enable":function(){return{link:f}},"link/disable":function(){return{link:f}},"link/pass":function(b){return{link:f,value:b}},"link/adapt":function(b){return{link:f,before:b[0],after:b[1]}}};this.event=G(a);this.events=I(a,this.event);this.enabled=Kefir.merge([this.event["link/disable"].mapTo(!1),
this.event["link/enable"].mapTo(!0)]).toProperty(!0);this.event["link/pass"].filterBy(this.enabled).onValue(function(b){c.receive(f.adapt(b))});Kefir.sampledBy([this.event["link/pass"]],[this.event["link/enable"]]).onValue(function(b){f.pass(b[0])})}function O(b){return"undefined"!==typeof b}function u(b){return b?"function"===typeof b?b():b:null}function M(b){if(!b)return{};var a={},c;for(c in b)a[c]=u(b[c]);return a}function G(b){var a={},c;for(c in b)a[c]=Kefir.emitter();return a}function I(b,
a){var c=Kefir.pool(),e;for(e in b)(function(b,e){c.plug(a[b].map(function(a){a=e(a);a.type=b;return a}))})(e,b[e]);return c}function D(b,a){a=a||Error(b);console&&(console.error?console.error(a):console.log(a));throw a;}function C(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function H(b,a){return[a,Array.isArray(b)?b:[b,null]]}function K(b,a){b&&(Array.isArray(b)?(a(b[0]),K(b[1],a)):a(b))}function P(b,a,c){for(var e=[],f=0,l=a.length;f<l;f++)e.push(a[f](c));return function(a,
c){b(a,c);for(var f=0,l=e.length;f<l;f++)e[f](a,c)}}var t={},e={},l={},f={},d={},p={},r={},k={},T=-1,S=[];a.prototype.attachTo=function(b){this.targets.emit(b);return this};a.prototype.addNode=function(b){this.events.plug(b.events);this.event["node/add"].emit(b);b.turnOn();return this};a.prototype.removeNode=function(b){b.turnOff();this.event["node/remove"].emit(b);this.events.unplug(b.events);return this};a.prototype.renderWith=function(b,a){if(!r[b])throw Error("Renderer "+b+" is not registered");
var c=r[b](a);k[b]&&k[b].length?this.renderers.emit(P(c,k[b]),a):this.renderers.emit(c);return this};a.start=function(b){b=new a(b);S.push(b);T++;return b};g.prototype.turnOn=function(){this.event["node/turn-on"].emit(this)};g.prototype.turnOff=function(){this.event["node/turn-off"].emit(this)};g.prototype.addInlet=function(b,a,e,f,l,d,h){b=new c(b,this,a,e,f,l,d,h);this.events.plug(b.events);this.event["inlet/add"].emit(b);b.toDefault();return b};g.prototype.addOutlet=function(b,a,c,e){b=new h(b,
this,a,c,e);this.events.plug(b.events);this.event["outlet/add"].emit(b);return b};g.prototype.removeInlet=function(b){this.event["inlet/remove"].emit(b);this.events.unplug(b.events)};g.prototype.removeOutlet=function(b){this.event["outlet/remove"].emit(b);this.events.unplug(b.events)};c.prototype.receive=function(b){this.value.emit(b)};c.prototype.stream=function(b){this.value.plug(b)};c.prototype.toDefault=function(){O(this.default)&&this.default instanceof Kefir.Stream?this.stream(this.default):
this.receive(this.default)};h.prototype.connect=function(b,a){var c=new y(null,this,b,a);this.events.plug(c.events);this.value.onValue(c.receiver);this.event["outlet/connect"].emit(c);return c};h.prototype.disconnect=function(b){this.event["outlet/disconnect"].emit(b);this.value.offValue(b.receiver);this.events.unplug(b.events)};h.prototype.send=function(b){this.value.emit(this.adapt?this.adapt(b):b)};h.prototype.stream=function(b){this.value.plug(this.adapt?b.map(this.adapt):b)};y.prototype.pass=
function(b){this.event["link/pass"].emit(b)};y.prototype.adapt=function(b){if(this.adapter){var a=this.adapter(b);this.event["link/adapt"].emit([b,a]);return a}this.event["link/adapt"].emit([b,b]);return b};y.prototype.enable=function(){this.event["link/enable"].emit()};y.prototype.disable=function(){this.event["link/disable"].emit()};y.prototype.disconnect=function(){this.outlet.disconnect(this)};return{Model:a,Node:g,Inlet:c,Outlet:h,Link:y,nodetype:function(b,a){t[b]=a},linktype:function(b,a){e[b]=
a},channeltype:function(b,a){l[b]=a},nodedescription:function(b,a){p[b]=a},renderer:function(b,a){r[b]=a},subrenderer:function(b,a){k[b]||(k[b]=[]);k[b].push(a)},noderenderer:function(b,a,c){if(!t[b])throw Error("Node type "+b+" is not registered");f[b]||(f[b]={});f[b][a]=c},channelrenderer:function(b,a,c){if(!l[b])throw Error("Channel type "+b+" is not registered");d[b]||(d[b]={});d[b][a]=c},allNodeTypes:t,allDescriptions:p,short_uid:C,currentModel:function(){return S[T]}}}();(function(){function a(a){function l(b){b.preventDefault();b.stopPropagation()}function f(b){return{x:b.clientX,y:b.clientY}}function d(b){b=b.getBoundingClientRect();return{x:b.left,y:b.top}}function p(b){return function(a){return{pos:a,target:b}}}function r(b){return!b}function k(b,a,c,e){Kefir.fromEvent(b,"click").tap(l).mapTo(e||!1).scan(r).onValue(function(b){b?a():c()})}function t(b,a,U,e,m){m=c("div","rpd-value-editor");var A=Kefir.emitter(),f=Kefir.emitter();a.disableEditor=f;b.render.html.edit(m,
b,A).onValue(function(a){b.receive(a)});Kefir.sampledBy([b.event["inlet/update"]],[Kefir.merge([Kefir.fromEvent(e,"click").tap(l).mapTo(!0),Kefir.fromEvent(U,"click").merge(f).mapTo(!1)]).toProperty(!1).skipDuplicates()]).map(function(b){return{lastValue:b[0],startEditing:b[1],cancelEditing:!b[1]}}).onValue(function(b){b.startEditing?(a.link&&a.link.disable(),A.emit(b.lastValue),e.classList.add("rpd-editor-enabled")):b.cancelEditing&&e.classList.remove("rpd-editor-enabled")});e.classList.add("rpd-editor-disabled");
e.appendChild(m)}function C(b,a){if(a)for(var c in a)(function(a,c){b.event["inlet/add"].filter(function(b){return b.alias===c}).onValue(function(b){a.default&&b.receive(a.default());if(a.valueOut)a.valueOut.onValue(function(a){b.receive(a)})})})(a[c],c)}function b(b,a){for(var c,e,m,f=0,l=a.length;f<l;f++)c=a[f].link,e=a[f].elm,m=x[c.inlet.id].connectorElm,c=L[c.outlet.id].connectorElm,m=d(m),c=d(c),M(e,c.x,c.y,m.x,m.y)}function F(a,c,e,h){e.classList.add("rpd-drag-handle");var m;Kefir.fromEvent(e,
"mousedown").map(f).flatMap(function(b){h.classList.add("rpd-dragging");var a=d(h),e=b.x-a.x,U=b.y-a.y;m=null;h.style.zIndex=1;return Kefir.fromEvent(c,"mousemove").tap(l).takeUntilBy(Kefir.fromEvent(c,"mouseup")).map(f).map(function(b){return{x:b.x-e,y:b.y-U}}).onEnd(function(){h.classList.remove("rpd-dragging");h.style.zIndex=0;if(m)for(var b=0,a=m.length;b<a;b++)m[b].elm.style.zIndex=2})}).onValue(function(c){h.style.left=c.x+"px";h.style.top=c.y+"px";m||(m=G(a,q,function(b){b.elm.style.zIndex=
3}));b(a,m)})}function K(b,a,e){var f={},m=[],d,E,g,B;for(d in a)g=d.split("/"),E=g[0],B=g[1],m.push([g,E,B]),f[E]||(f[E]={}),f[E][B]=a[d];var n=c("dl","rpd-nodelist"),v,p,V;for(E in f){v=h("dd","rpd-toolkit-name",E);n.appendChild(v);a=c("dt");m=c("dl","rpd-toolkit");d=f[E];for(B in d)d=E+"/"+B,p=h("dd","rpd-node-title",B),V=h("span","rpd-add-node","+ Add"),p.appendChild(V),g=h("dd","rpd-node-description",e[d]||"[No Description]"),m.appendChild(p),m.appendChild(g),g.classList.add("rpd-collapsed"),
function(b){k(p,function(){b.classList.add("rpd-collapsed")},function(){b.classList.remove("rpd-collapsed")})}(g),function(b){Kefir.fromEvent(V,"click").tap(l).onValue(function(){new Rpd.Node(b)})}(d);a.appendChild(m);n.appendChild(a);(function(b){k(v,function(){b.classList.add("rpd-collapsed")},function(){b.classList.remove("rpd-collapsed")},!0)})(m)}b.appendChild(n);var w=c("span","rpd-collapse-nodelist");w.innerText=w.textContent=">>";k(w,function(){w.classList.add("rpd-collapsed");w.innerText=
w.textContent="<<";n.classList.add("rpd-collapsed")},function(){w.classList.remove("rpd-collapsed");w.innerText=w.textContent=">>";n.classList.remove("rpd-collapsed")},!0);b.appendChild(w)}var J,L,x,q,n=g(a,D),H=function(){var b,a,c,e,m,h,g,k=function(b){return function(){return x[b.id].link}};return{init:function(f){g=f;b=Kefir.fromEvent(f,"click");a=Kefir.pool();c=Kefir.pool();e=Kefir.emitter();m=Kefir.emitter();h=Kefir.merge([e.mapTo(!0),m.mapTo(!1)]).toProperty(!1)},subscribeOutlet:function(k,
Q){c.plug(Kefir.fromEvent(Q,"click").map(f).map(p(k)));Kefir.fromEvent(Q,"click").tap(l).filterBy(c.awaiting(h)).map(f).onValue(function(l){e.emit();var h=d(Q),A=u(h.x,h.y,l.x,l.y,n.linkWidth);g.appendChild(A);return Kefir.fromEvent(g,"mousemove").takeUntilBy(Kefir.merge([a,c.mapTo(!1),b.mapTo(!1)]).take(1).onValue(function(b){if(b){b=b.target;var a=x[b.id].link;a&&a.outlet.disconnect(a);k.connect(b)}})).map(f).onValue(function(b){M(A,h.x,h.y,b.x,b.y)}).onEnd(function(){g.removeChild(A);m.emit()})})},
subscribeInlet:function(B,r){a.plug(Kefir.fromEvent(r,"click").map(f).map(p(B)));Kefir.fromEvent(r,"click").tap(l).filterBy(a.awaiting(h)).filter(k(B)).onValue(function(l){var h=x[B.id].link,A=h.outlet;A.disconnect(h);e.emit();var k=d(L[A.id].connectorElm),Q=u(k.x,k.y,l.x,l.y,n.linkWidth);g.appendChild(Q);return Kefir.fromEvent(g,"mousemove").takeUntilBy(Kefir.merge([a,c.mapTo(!1),b.mapTo(!1)]).take(1).onValue(function(b){if(b){b=b.target;var a=x[b.id].link;a&&a.outlet.disconnect(a);A.connect(b)}})).map(f).onValue(function(b){M(Q,
k.x,k.y,b.x,b.y)}).onEnd(function(){g.removeChild(Q);m.emit()})})}}}(),P=Rpd.allDescriptions;return{"model/new":function(b,a){J={};L={};x={};q={};b.classList.add("rpd-model");n.layout&&b.classList.add("rpd-layout-"+n.layout);n.valuesOnHover?b.classList.add("rpd-values-on-hover"):b.classList.add("rpd-values-always-shown");n.showBoxes&&b.classList.add("rpd-show-boxes");b.style.height=document.documentElement.clientHeight+"px";Kefir.fromEvent(b,"resize").onValue(function(){b.style.height=document.documentElement.clientHeight+
"px"});H.init(b);n.renderNodeList&&K(b,Rpd.allNodeTypes,P);Kefir.fromEvent(b,"selectstart").onValue(function(b){b.preventDefault()})},"node/add":function(b,a){var e=a.node,f=c("div","rpd-node-box"),m=c("table","rpd-node"),d,g,k,p,r;if("quartz"==n.layout){d=c("thead","rpd-title");g=c("tr");var v=c("tr","rpd-remove-button");r=c("th");r.innerText=r.textContent="x";v.appendChild(r);d.appendChild(v);v=c("th");v.setAttribute("colspan",3);v.appendChild(h("span","rpd-name",e.name));n.showTypes&&v.appendChild(h("span",
"rpd-type",e.type));g.appendChild(v);d.appendChild(g);var y=c("tbody","rpd-content"),t=c("tr"),w=c("td","rpd-inlets");p=c("table");var u=c("tbody");g=u;p.appendChild(u);w.appendChild(p);p=c("div");u=c("td","rpd-body");k=c("table");var q=c("tr"),z=c("td");z.appendChild(p);q.appendChild(z);k.appendChild(q);u.appendChild(k);var q=c("td","rpd-outlets"),z=c("table"),x=c("tbody");k=x;z.appendChild(x);q.appendChild(z);t.appendChild(w);t.appendChild(u);t.appendChild(q);y.appendChild(t);m.appendChild(d);m.appendChild(y)}else"pd"==
n.layout&&(r=c("tr","rpd-inlets"),w=c("td"),p=c("table"),g=u=c("tbody"),p.appendChild(u),w.appendChild(p),r.appendChild(w),m.appendChild(r),v=c("tr","rpd-remove-button"),r=c("td"),r.innerText=r.textContent="x",v.appendChild(r),m.appendChild(v),t=c("tr","rpd-content"),v=c("td","rpd-title"),v.appendChild(h("span","rpd-name",e.name)),n.showTypes&&v.appendChild(h("span","rpd-type",e.type)),t.appendChild(v),u=c("td","rpd-body"),p=c("div"),k=c("table"),q=c("tr"),z=c("td"),z.appendChild(p),q.appendChild(z),
k.appendChild(q),u.appendChild(k),t.appendChild(u),m.appendChild(t),d=c("tr","rpd-outlets"),q=c("td"),z=c("table"),k=x=c("tbody"),z.appendChild(x),q.appendChild(z),d.appendChild(q),m.appendChild(d),d=v);m.classList.add("rpd-"+e.type.replace("/","-"));f.style.zIndex=0;P[e.type]&&(v.title=P[e.type]);I(e,f,m,n.boxSize,[b.offsetWidth,b.offsetHeight]);f.appendChild(m);b.appendChild(f);J[e.id]={box:f,elm:m,body:p,inletsTrg:g,outletsTrg:k};e.render.html&&e.render.html.first&&C(e,e.render.html.first(p));
n.nodesMovingAllowed&&F(e,b,d,f);Kefir.fromEvent(r,"click").tap(l).onValue(function(){Rpd.currentModel().removeNode(e)})},"node/process":function(b,a){var c=a.node;c.render.html&&c.render.html.always&&c.render.html.always(J[c.id].body,a.inlets,a.outlets)},"node/remove":function(b,a){for(var c=a.node,e=J[c.id],f=G(c,q),d,l=0,h=f.length;l<h;l++)d=f[l],d.link.outlet.disconnect(d.link);b.removeChild(e.box);J[c.id]=null},"inlet/add":function(b,a){var e=a.inlet;if(!e.hidden){var f=J[e.node.id].inletsTrg,
d,l,g;"quartz"==n.layout?(d=c("tr","rpd-inlet rpd-stale"),g=c("td","rpd-connector"),valueHolder=c("td","rpd-value-holder"),l=c("span","rpd-value"),valueHolder.appendChild(l),d.appendChild(g),d.appendChild(valueHolder),d.appendChild(h("td","rpd-name",e.name)),n.showTypes&&d.appendChild(h("td","rpd-type",e.type))):"pd"==n.layout&&(d=c("td","rpd-inlet rpd-stale"),g=c("span","rpd-connector"),valueHolder=c("span","rpd-value-holder"),l=c("span","rpd-value"),valueHolder.appendChild(l),d.appendChild(g),d.appendChild(h("span",
"rpd-name",e.name)),d.appendChild(valueHolder),n.showTypes&&d.appendChild(h("span","rpd-type",e.type)));d.classList.add("rpd-"+e.type.replace("/","-"));f.appendChild(d);var k={elm:d,valueElm:l,connectorElm:g,disableEditor:null,link:null};x[e.id]=k;e.readonly&&d.classList.add("rpd-readonly");e.cold&&d.classList.add("rpd-cold");!e.readonly&&e.render.html&&e.render.html.edit&&t(e,k,b,valueHolder,l);e.event["inlet/update"].onError(function(){y(k,d,n.effectTime)});H.subscribeInlet(e,g)}},"inlet/update":function(b,
a){var c=a.inlet;if(!c.hidden){var e=x[c.id],d=e.elm,f=e.valueElm,l=c.def.show?c.def.show(a.value):a.value;c.render.html&&c.render.html.show?c.render.html.show(f,a.value,l):f.innerText=f.textContent=l;O(e,d,n.effectTime)}},"outlet/add":function(b,a){var e=a.outlet,f=J[e.node.id].outletsTrg,d,l,g;"quartz"==n.layout?(d=c("tr","rpd-outlet rpd-stale"),g=c("td","rpd-connector"),l=c("td","rpd-value"),n.showTypes&&d.appendChild(h("td","rpd-type",e.type)),d.appendChild(h("td","rpd-name",e.name)),d.appendChild(l),
d.appendChild(g)):"pd"==n.layout&&(d=c("td","rpd-outlet rpd-stale"),g=c("span","rpd-connector"),l=c("span","rpd-value"),d.appendChild(g),d.appendChild(h("span","rpd-name",e.name)),d.appendChild(l),n.showTypes&&d.appendChild(h("span","rpd-type",e.type)));d.classList.add("rpd-"+e.type.replace("/","-"));f.appendChild(d);L[e.id]={elm:d,valueElm:l,connectorElm:g,links:{}};H.subscribeOutlet(e,g)},"outlet/update":function(b,a){var c=a.outlet,e=L[c.id],d=e.elm,f=e.valueElm;c.render.html&&c.render.html.show?
c.render.html.show(f,a.value):f.innerText=f.textContent=c.def.show?c.def.show(a.value):a.value;O(e,d,n.effectTime)},"outlet/connect":function(b,a){var c=a.link,e=c.outlet,d=L[e.id],f=x[c.inlet.id],l=d.connectorElm,g=f.connectorElm;d.links[e.id]=c;if(f.link)throw Error("Inlet is already connected to a link");f.link=c;f.disableEditor&&f.disableEditor.emit();e=l.getBoundingClientRect();g=g.getBoundingClientRect();g=u(e.left,e.top,g.left,g.top,n.linkWidth);q[c.id]={elm:g,link:c};k(g,function(){c.enable()},
function(){c.disable()});b.appendChild(g)},"outlet/disconnect":function(b,a){var c=a.link,e=q[c.id].elm,d=x[c.inlet.id];L[c.outlet.id].links[c.id]=null;d.link=null;q[c.id]=null;b.removeChild(e)},"link/enable":function(b,a){q[a.link.id].elm.classList.remove("rpd-disabled")},"link/disable":function(b,a){q[a.link.id].elm.classList.add("rpd-disabled")}}}function g(a,c){if(a){var f={},d;for(d in c)f[d]=c[d];for(d in a)f[d]=a[d];return f}return c}function c(a,c){var f=document.createElement(a);c&&(f.className=
c);return f}function h(a,c,f){a=document.createElement(a);c&&(a.className=c);a.innerText=a.textContent=f;return a}function y(a,c,f){c.classList.add("rpd-error");a.errRemoveTimeout&&clearTimeout(a.errRemoveTimeout);a.errRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-error");a.errRemoveTimeout=null},f||1)}function O(a,c,f){c.classList.remove("rpd-stale");c.classList.add("rpd-fresh");a.updRemoveTimeout&&clearTimeout(a.updRemoveTimeout);a.updRemoveTimeout=setTimeout(function(){c.classList.remove("rpd-fresh");
c.classList.add("rpd-stale");a.updRemoveTimeout=null},f||1)}function u(a,g,f,d,h){var r=Math.sqrt((a-f)*(a-f)+(g-d)*(g-d));f=Math.atan2(d-g,f-a);d=c("span","rpd-link");d.style.position="absolute";d.style.zIndex=2;d.style.width=Math.floor(r)+"px";d.style.left=a+"px";d.style.top=g+"px";d.style.transformOrigin="left top";d.style.webkitTransformOrigin="left top";d.style.transform="rotateZ("+f+"rad)";d.style.webkitTransform="rotateZ("+f+"rad)";h&&(d.style.height=h+"px");return d}function M(a,c,f,d,g){var h=
Math.sqrt((c-d)*(c-d)+(f-g)*(f-g));d=Math.atan2(g-f,d-c);a.style.left=c+"px";a.style.top=f+"px";a.style.width=Math.floor(h)+"px";a.style.transform="rotateZ("+d+"rad)";a.style.webkitTransform="rotateZ("+d+"rad)"}function G(a,c,f){var d=[],g,h,k;for(k in c)c[k]&&(g=c[k],h=g.link,h.inlet.node.id===a.id||h.outlet.node.id===a.id)&&(d.push(g),f&&f(g,h));return d}function I(a,c,f,d,g){var h=(a.def.width||C)*d[0],k=t.length?t[t.length-1]:null;a=[k?k[0]:0,k?k[1]+k[3]+P*d[1]:0,h,(a.def.height||H)*d[1]];a[1]+
d[1]>g[1]&&(a[0]=a[0]+h+K*d[0],a[1]=0);t.push(a);c.style.left=Math.floor(a[0])+"px";c.style.top=Math.floor(a[1])+"px";f.style.minWidth=Math.floor(a[2])+"px";f.style.minHeight=Math.floor(a[3])+"px";t.push(a)}var D={layout:"quartz",valuesOnHover:!1,showTypes:!1,showBoxes:!1,nodesMovingAllowed:!0,renderNodeList:!0,nodeListCollapsed:!0,boxSize:[100,40],linkWidth:null,effectTime:1E3},C=1,H=1,K=.5,P=1,t=[];Rpd.HtmlRenderer=a;Rpd.renderer("html",function(c){var g=a(c);return function(a,c){if(g[c.type])g[c.type](a,
c)}})})();Rpd.nodedescription("core/empty","Does not allow adding any inlets or outlets.");Rpd.nodetype("core/empty",{name:"Empty",handle:{"inlet/add":function(){throw Error("Empty node can not have any inlets");},"outlet/add":function(){throw Error("Empty node can not have any outlets");}}});Rpd.nodedescription("core/custom","May have any number of inlets and outlets, a target for extension.");Rpd.nodetype("core/custom",{name:"Custom"});
Rpd.nodetype("core/sum-of-three",{name:"Sum of Three",width:1.8,inlets:{a:{type:"core/number",name:"A"},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C"}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(a){return{sum:(a.a||0)+(a.b||0)+(a.c||0)}}});
Rpd.nodetype("core/sum-of-three-with-body",{name:"Sum of Three w/Body",width:1.8,inlets:{a:{type:"core/number",name:"A",default:1},b:{type:"core/number",name:"B"},c:{type:"core/number",name:"C",hidden:!0}},outlets:{sum:{type:"core/number",name:"\u2211"}},process:function(a){return{sum:(a.a||0)+(a.b||0)+(a.c||0)}}});Rpd.nodedescription("core/hot-and-cold","An example of cold inlet.");
Rpd.nodetype("core/hot-and-cold",{name:"Hot and Cold",inlets:{hot:{type:"core/number",name:"A",default:1},cold:{type:"core/number",name:"B",default:1,cold:!0}},outlets:{value:{type:"core/any"}},process:function(a){return{value:[a.hot,a.cold]}}});Rpd.channeltype("core/any",{});Rpd.channeltype("core/boolean",{default:!1,adapt:function(a){return a?!0:!1}});Rpd.channeltype("core/number",{default:0,readonly:!1,accept:function(a){a=parseFloat(a);return!isNaN(a)&&isFinite(a)},adapt:function(a){return parseFloat(a)}});
Rpd.linktype("core/pass",{});Rpd.noderenderer("core/sum-of-three","html",{always:function(a,g,c){a.innerHTML="\u2211 ("+(g.a||"?")+", "+(g.b||"?")+", "+(g.c||"?")+") = "+(c.sum||"?")}});
Rpd.noderenderer("core/sum-of-three-with-body","html",function(){var a;return{first:function(g){var c=document.createElement("input");c.style.display="block";c.type="number";c.min=0;c.max=10;g.appendChild(c);a=document.createElement("span");g.appendChild(a);return{c:{default:function(){return c.value=0},valueOut:Kefir.fromEvent(c,"change").map(function(){return c.value})}}},always:function(g,c,h){a.innerHTML=a.textContent="\u2211 ("+(c.a||"0")+", "+(c.b||"0")+", "+(c.c||"0")+") = "+(h.sum||"?")}}});
Rpd.channelrenderer("core/number","html",{edit:function(a,g,c){var h=document.createElement("input");h.type="number";c.onValue(function(a){h.value=a});a.appendChild(h);return Kefir.fromEvent(h,"change").map(function(){return h.value})}});Rpd.channeltype("anm/color",{accept:function(a){return"string"===typeof a&&(0==a.indexOf("#")||0==a.indexOf("rgb"))}});Rpd.channeltype("anm/element",{show:function(a){return a?"[Element]":"[Nothing]"}});
Rpd.nodetype("anm/color",{name:"color",inlets:{red:{type:"core/number",default:255},green:{type:"core/number",default:255},blue:{type:"core/number",default:255},alpha:{type:"core/number",default:1}},outlets:{color:{type:"anm/color",default:"rgba(255, 255, 255, 1)"}},process:function(a){return{color:"rgba("+a.red+","+a.green+","+a.blue+","+a.alpha+")"}}});
Rpd.nodetype("anm/element",function(){var a;return{name:"element",inlets:{x:{type:"core/number",default:0},y:{type:"core/number",default:0},color:{type:"anm/color",default:"rgba(99, 255, 255, 1)"}},outlets:{element:{type:"anm/element",default:null}},process:function(g){a||(a=new anm.Element,a.rect(0,0,20,20));a.x=g.x;a.y=g.y;a.fill(g.color);return{element:a}}}});Rpd.nodetype("anm/number",{name:"number",inlets:{spinner:{type:"core/number",default:0,hidden:!0}},outlets:{out:{type:"core/number"}},process:function(a){if(a.hasOwnProperty("spinner"))return{out:a.spinner}}});Rpd.noderenderer("anm/number","html",{first:function(a){var g=document.createElement("span"),c=attachSpinner(g,0);a.appendChild(g);return{spinner:{default:function(){c.emit(0);return 0},valueOut:c.map(function(a){return parseFloat(a)})}}}});Rpd.noderenderer("anm/color","html",function(){var a;return{first:function(g){a=document.createElement("div");a.classList.add("rpd-anm-color-body");g.appendChild(a)},always:function(g,c,h){a.style.backgroundColor=h.color}}});
Rpd.noderenderer("anm/element","html",function(){var a;return{first:function(g){var c=document.createElement("div");g.appendChild(c);a=anm.createPlayer(c,{width:100,height:100,controlsEnabled:!1,repeat:!0})},always:function(g,c,h){h.element&&(a.stop(),a.load(h.element),a.play())}}});Rpd.channelrenderer("anm/color","html",{show:function(a,g,c){a.style.backgroundColor=c||g}});function extractPos(a){return{x:a.clientX,y:a.clientY}}
function attachSpinner(a,g){a.classList.add("rpd-anm-spinner");var c=g=g||0,h=Kefir.emitter();h.onValue(function(g){c=g;a.innerText=a.textContent=g});h.emit(g);Kefir.fromEvent(a,"mousedown").map(extractPos).flatMap(function(a){var g=c;return Kefir.fromEvent(document.body,"mousemove").map(extractPos).takeUntilBy(Kefir.fromEvent(document.body,"mouseup")).onValue(function(c){h.emit(g+(c.x-a.x))})}).onEnd(function(){});return h};
