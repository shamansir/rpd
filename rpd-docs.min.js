/**
 * rpd - RPD is a minimal framework for building Node-Based User Interfaces, powered by Reactive Programming
 * Built at Tue, 19 Jul 2016 01:21:30 GMT
 *
 * @version v2.0.0
 * @link https://shamansir.github.io/rpd
 * @author Ulric Wilfred <shaman.sir@gmail.com>
 * @license MIT
 *
 * Selected Renderers: svg
 * Selected Styles: compact-v
 * Selected Toolkits: util
 * Selected I/O Modules: [None]
 * Selected Navigation Modules: [None]
 * d3.js or d3_tiny.js: d3_tiny.js
 *
 * User Styles: [None]
 * User Toolkits: [None]
 *
 * Command: gulp --renderer svg --style compact-v --toolkit util --target-name rpd-docs --compilation simple
 */
(function(l){var d=l.Kefir;"undefined"===typeof d&&"undefined"!==typeof require&&(d=require("../vendor/kefir.min.js"));if(!d)throw Error("Kefir.js (https://github.com/rpominov/kefir) is required for Rpd to work");var a=function(){function b(f){return function(){return f}}function q(){var f=d.emitter();f.map(function(f){return{rule:f,func:function(a){a.render(f.aliases,f.targets,f.config)}}}).scan(function(f,a){f&&M["network/add-patch"].offValue(f.func);M["network/add-patch"].onValue(a.func);return a},
null).last().onValue(function(f){M["network/add-patch"].offValue(f.func)});return f}function g(f,a){c(f);var h=new m(f,a||f);M["network/add-patch"].emit(h);return h}function m(f,a){this.id=I();this.name=f;this.def=a||{};var h=this,c={"patch/is-ready":[],"patch/open":["parent"],"patch/close":[],"patch/move-canvas":["position"],"patch/resize-canvas":["size"],"patch/set-inputs":["inputs"],"patch/set-outputs":["outputs"],"patch/project":["node","target"],"patch/refer":["node","target"],"patch/add-node":["node"],
"patch/remove-node":["node"]};this.event=z(c);this.events=F(c,this.event,"patch",this);this.def.handle&&G(this.events,this.def.handle);this.renderQueue=d.emitter();c=d.combine([this.events],[this.renderQueue.scan(function(f,a){var c=a.alias,A=a.target,n=a.config,e=f[c];e||(e={},e.produce=T[c](h),e.handlers=[],f[c]=e);if(e.produce){var b=e.produce(A,n);b&&e.handlers.push("function"===typeof b?b:function(f){if(b[f.type])b[f.type](f)})}return f},{})]);c=c.bufferBy(this.renderQueue).take(1).flatten().concat(c);
c.onValue(function(f){var a=f[0];f=f[1];for(var c=Object.keys(f),h,S=0,A=c.length;S<A;S++){h=f[c[S]];h=h.handlers;for(var n=0,e=h.length;n<e;n++)h[n](J(u(a),c[S]))}});this.projections=d.emitter();d.combine([this.projections],[this.event["patch/set-inputs"],this.event["patch/set-outputs"]]).onValue(function(f){var a=f[0],c=f[1];f=f[2];for(var n,A=0;A<c.length;A++)n=a.addInlet(c[A].type,c[A].alias,c[A].def,c[A].render),n.event["inlet/update"].onValue(function(f){return function(a){f.receive(a)}}(c[A]));
for(A=0;A<f.length;A++)c=a.addOutlet(f[A].type,f[A].alias,f[A].def,f[A].render),f[A].event["outlet/update"].onValue(function(f){return function(a){f.send(a)}}(c));h.event["patch/project"].emit({node:a,target:a.patch});a.patch.event["patch/refer"].emit({node:a,target:h})});this.nodesToRemove=d.emitter();this.event["patch/is-ready"].emit()}function k(f,a,c,h,e){this.type=f||"core/basic";this.toolkit=U(f);this.id=I();this.patch=a;f={"node/turn-on":[],"node/is-ready":[],"node/process":["inlets","outlets"],
"node/turn-off":[],"node/add-inlet":["inlet"],"node/remove-inlet":["inlet"],"node/add-outlet":["outlet"],"node/remove-outlet":["outlet"],"node/move":["position"]};this.event=z(f);this.events=F(f,this.event,"node",this);(f=C(t[this.type],this))||x(this,"node","Node type '"+this.type+"' is not registered!");this.def=n(Q,c,f);this.render=H(ca,h,E(R[this.type],this));e&&e(this);var b=this;this.def.handle&&G(this.events,this.def.handle);if(this.def.process){var v=this.def.process;c=d.combine([this.event["node/add-inlet"].flatMap(function(f){var a=
f.event["inlet/update"].map(function(a){return{inlet:f,value:a}});b.def.tune&&(a=b.def.tune.bind(b)(a));return a})],[this.event["node/add-outlet"].scan(function(f,a){f[a.alias]=a;return f},{})]);c=c.bufferBy(this.event["node/is-ready"]).take(1).flatten().concat(c);c=c.scan(function(f,a){var c=a[0].inlet,h=c.alias;f.inlets.prev[h]=f.inlets.cur[h];f.inlets.cur[h]=a[0].value;f.outlets=a[1];f.source=c;return f},{inlets:{prev:{},cur:{}},outlets:{}}).changes();c=c.filter(function(f){return!f.source.def.cold});
c.onValue(function(f){var a=v.bind(b)(f.inlets.cur,f.inlets.prev);b.event["node/process"].emit({inlets:f.inlets.cur,outlets:a});f=f.outlets;for(var c in a)f[c]&&(a[c]instanceof d.Stream?f[c].stream(a[c]):f[c].send(a[c]))})}if(this.def.inlets){this.inlets={};for(var r in this.def.inlets)c=this.def.inlets[r],c=this.addInlet(c.type,r,c),this.inlets[r]=c}if(this.def.outlets)for(r in this.outlets={},this.def.outlets)c=this.def.outlets[r],c=this.addOutlet(c.type,r,c),this.outlets[r]=c;this.def.prepare&&
this.def.prepare.bind(this)(this.inlets,this.outlets);this.event["node/is-ready"].emit()}function l(f,a,c,e,b){this.type=f||"core/any";this.toolkit=U(f);this.id=I();this.alias=c;this.node=a;(f=C(K[this.type],this))||x(this,"inlet","Channel type '"+this.type+"' is not registered!");this.def=n(h,e,f);this.alias||D(this,"inlet","Inlet should have an alias");this.value=d.pool();this.render=H(X,b,E(N[this.type],this));e={"inlet/update":["value"]};this.event=z(e);var r=this.event["inlet/update"];b=r.merge(this.value);
this.def.tune&&(b=this.def.tune.bind(this)(b));this.def.accept&&(b=b.flatten(function(f){if(this.def.accept(f))return[f];r.error({type:"inlet/error",system:!1,subject:this,message:void 0,silent:!0});return[]}.bind(this)));this.def.adapt&&(b=b.map(this.def.adapt));this.event["inlet/update"]=b.onValue(function(){});this.events=F(e,this.event,"inlet",this);this.def.handle&&G(this.events,this.def.handle)}function e(f,a,c,h,b){this.type=f||"core/any";this.toolkit=U(f);this.id=I();this.alias=c;this.node=
a;(f=C(K[this.type],this))||x(this,"outlet","Channel type '"+this.type+"' is not registered!");this.def=n(v,h,f);this.alias||D(this,"outlet","Outlet should have an alias");this.value=d.pool();this.render=H(X,b,E(N[this.type],this));h={"outlet/update":["value"],"outlet/connect":["link","inlet"],"outlet/disconnect":["link"]};this.event=z(h);b=this.event["outlet/update"].merge(this.value);this.event["outlet/update"]=b.onValue(function(f){});this.events=F(h,this.event,"outlet",this);this.def.handle&&
G(this.events,this.def.handle);var e=this;d.combine([this.event["outlet/connect"]],[this.event["outlet/update"]]).onValue(function(f){e.value.plug(d.constant(f[1]))})}function B(f,a,c){this.id=I();this.name=c||"";this.outlet=f;this.inlet=a;this.value=d.emitter();var h=this;this.receiver=f.node.id!==a.node.id?function(f){h.pass(f)}:function(f){setTimeout(function(){h.pass(f)},0)};f={"link/enable":[],"link/disable":[],"link/pass":["value"]};this.event=z(f);c=this.event["link/pass"].merge(this.value);
this.event["link/pass"]=c.onValue(function(f){});this.events=F(f,this.event,"link",this);this.enabled=d.merge([this.event["link/disable"].map(b(!1)),this.event["link/enable"].map(b(!0))]).toProperty(b(!0));this.event["link/pass"].filterBy(this.enabled).onValue(function(f){a.receive(f)});d.combine([this.event["link/enable"]],[this.event["link/pass"]]).onValue(function(f){h.pass(f[1])})}function n(f,a,c){var h={};a=a||{};c=c||{};for(var b,e=0,n=f.length;e<n;e++)if(b=f[e],"*"!==b[0]){if(b in a||b in
c)h[b]=r(a[b])?a[b]:c[b]}else if(b=b.slice(1),b in a||b in c){h[b]={};for(var v=c[b]?Object.keys(c[b]):[],u=0,d=v.length;u<d;u++)h[b][v[u]]=c[b][v[u]];v=a[b]?Object.keys(a[b]):[];u=0;for(d=v.length;u<d;u++)h[b][v[u]]=a[b][v[u]]}return h}function u(f){for(var a={},c=Object.keys(f),h=0,b=c.length;h<b;h++)a[c[h]]=f[c[h]];return a}function c(f){return"object"===typeof f}function r(f){return"undefined"!==typeof f}function C(f,a){return f?"function"===typeof f?f(a):f:null}function E(f,a){if(!f)return{};
var c={},h;for(h in f)c[h]=C(f[h],a);return c}function H(f,a,c){if(!a)return c;var h={},b;for(b in c)h[b]=n(f,a[b],c[b]);for(b in a)h[b]||c[b]||(h[b]=a[b]);return h}function z(f){var a={};f=Object.keys(f);for(var c=0,h;c<f.length;c++)h=f[c],a[h]=d.emitter();return a}function p(f,a){if(0===a.length)return function(){return{type:f}};if(1===a.length)return function(c){var h={};h.type=f;h[a[0]]=c;return h};if(1<a.length)return function(a){a=u(a);a.type=f;return a}}function F(a,c,h,b){for(var e=d.pool(),
n=Object.keys(a),v=0;v<n.length;v++)e.plug(c[n[v]].map(p(n[v],a[n[v]])).map(function(a){a[h]=b;return a}));return e}function G(a,c){a.filter(function(a){return c[a.type]}).onValue(function(a){c[a.type](a)})}function D(a,c,h,b){V.plug(d.constantError({type:c+"/error",system:b||!1,subject:a,message:h}))}function x(a,c,h){D(a,c,h,!0)}function I(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}function J(a,c){var h=a.type;if("patch/add-node"===h||"node/process"===h)a.render=a.node.render[c]||
{};else if("node/add-inlet"===h||"inlet/update"===h)a.render=a.inlet.render[c]||{};else if("node/add-outlet"===h||"outlet/update"===h)a.render=a.outlet.render[c]||{};return a}function U(a){var c=a.indexOf("/");return 0<=c?a.substring(0,c):""}function W(a,c){t[a]=c||{}}function y(a,c){K[a]=c||{}}(function(){d.emitter=function(){var a,c=d.stream(function(c){a=c;return function(){a=void 0}});c.emit=function(c){a&&a.emit(c);return this};c.error=function(c){a&&a.error(c);return this};c.end=function(){a&&
a.end();return this};c.emitEvent=function(c){a&&a.emitEvent(c);return this};return c.setName("emitter")}})();var t={},Q="title *inlets *outlets prepare process tune *handle".split(" "),K={},h="label default hidden cold readonly allow accept adapt tune show *handle".split(" "),v=["label","tune","show","*handle"],R={},ca=["prepare","size","first","always"],N={},X=["prepare","show","edit"],Y={},O={},Z={},aa={},T={},ba={"network/add-patch":["patch"]},M=z(ba),V=F(ba,M,"network",a);M["network/add-patch"].onValue(function(a){V.plug(a.events)});
var P;m.prototype.render=function(a,c,h){a=Array.isArray(a)?a:[a];c=Array.isArray(c)?c:[c];for(var b=0,e=a.length,n;b<e;b++)for(var v=0,r=c.length,u;v<r;v++)n=a[b],u=c[v],T[n]||x(this,"patch","Renderer '"+n+"' is not registered"),this.renderQueue.emit({alias:n,target:u,config:h});return this};m.prototype.addNode=function(a,h,b,n){var e=this,v=b?b:c(h)?h||{}:{},r=c(h)?void 0:h;r&&(v.title=r);h=h&&c(h)?b:n;return new k(a,this,v,h,function(a){e.events.plug(a.events);e.event["patch/add-node"].emit(a);
a.turnOn()})};m.prototype.removeNode=function(a){a.turnOff();this.event["patch/remove-node"].emit(a);this.events.unplug(a.events)};m.prototype.open=function(a){this.event["patch/open"].emit(a);return this};m.prototype.close=function(){this.event["patch/close"].emit();return this};m.prototype.inputs=function(a){this.event["patch/set-inputs"].emit(a);return this};m.prototype.outputs=function(a){this.event["patch/set-outputs"].emit(a);return this};m.prototype.project=function(a){this.projections.emit(a);
return this};m.prototype.moveCanvas=function(a,c){this.event["patch/move-canvas"].emit([a,c]);return this};m.prototype.resizeCanvas=function(a,c){this.event["patch/resize-canvas"].emit([a,c]);return this};k.prototype.turnOn=function(){this.event["node/turn-on"].emit();return this};k.prototype.turnOff=function(){this.event["node/turn-off"].emit();return this};k.prototype.addInlet=function(a,h,b,n,e){var v=n?n:c(b)?b||{}:{},r=c(b)?void 0:b;r&&(v.label=r);b=b&&c(b)?n:e;a=new l(a,this,h,v,b);this.events.plug(a.events);
this.event["node/add-inlet"].emit(a);a.toDefault();return a};k.prototype.addOutlet=function(a,h,b,n,v){var r=n?n:c(b)?b||{}:{},u=c(b)?void 0:b;u&&(r.label=u);b=b&&c(b)?n:v;a=new e(a,this,h,r,b);this.events.plug(a.events);this.event["node/add-outlet"].emit(a);a.toDefault();return a};k.prototype.removeInlet=function(a){this.event["node/remove-inlet"].emit(a);this.events.unplug(a.events);return this};k.prototype.removeOutlet=function(a){this.event["node/remove-outlet"].emit(a);this.events.unplug(a.events);
return this};k.prototype.move=function(a,c){this.event["node/move"].emit([a,c]);return this};l.prototype.receive=function(a){this.value.plug(d.constant(a));return this};l.prototype.stream=function(a){this.value.plug(a);return this};l.prototype.toDefault=function(){r(this.def.default)&&(this.def.default instanceof d.Stream?this.stream(this.def.default):this.receive(this.def.default));return this};l.prototype.allows=function(a){if("core/any"===this.type||a.type===this.type)return!0;if(!this.def.allow&&
a.type!==this.type)return!1;if(this.def.allow){var c=!1;this.def.allow.forEach(function(h){a.type===h&&(c=!0)});return c}return!0};e.prototype.connect=function(a){a.allows(this)||D(this,"outlet","Outlet of type '"+this.type+"' is not allowed to connect to inlet of type '"+a.type+"'");var c=new B(this,a);this.events.plug(c.events);this.value.onValue(c.receiver);this.event["outlet/connect"].emit({link:c,inlet:a});return c};e.prototype.disconnect=function(a){this.event["outlet/disconnect"].emit(a);this.value.offValue(a.receiver);
this.events.unplug(a.events);return this};e.prototype.send=function(a){this.value.plug(d.constant(a));return this};e.prototype.stream=function(a){this.value.plug(a);return this};e.prototype.toDefault=function(){r(this.def.default)&&(this.def.default instanceof d.Stream?this.stream(this.def.default):this.send(this.def.default));return this};B.prototype.pass=function(a){this.value.emit(a);return this};B.prototype.enable=function(){this.event["link/enable"].emit();return this};B.prototype.disable=function(){this.event["link/disable"].emit();
return this};B.prototype.disconnect=function(){this.outlet.disconnect(this);return this};W("core/basic",{});W("core/reference",{});y("core/any",{});var L={patch:function(a){return"[ Patch"+(a.name?" '"+a.name+"'":" <Unnamed>")+" ]"},node:function(a){return"[ Node ("+a.type+")"+(a.def?a.def.title?" '"+a.def.title+"'":" <Untitled>":" <Unprepared>")+" #"+a.id+" ]"},outlet:function(a){return"[ Outlet ("+a.type+")"+(a.alias?" '"+a.alias+"'":" <Unaliased>")+(a.def?a.def.label?" '"+a.def.label+"'":" <Unlabeled>":
" <Unprepared>")+" #"+a.id+" ]"},inlet:function(a){return"[ Inlet ("+a.type+")"+(a.alias?" '"+a.alias+"'":" <Unaliased>")+(a.def?a.def.label?" '"+a.def.label+"'":" <Unlabeled>":" <Unprepared>")+" #"+a.id+(a.def.hidden?" (hidden)":"")+(a.def.cold?" (cold)":"")+" ]"},link:function(a){return"[ Link ("+a.type+") '"+a.name+"' #"+a.id+" "+L.outlet(a.outlet)+" -> "+L.inlet(a.inlet)+" ]"}};return{VERSION:"v2.0.0",_:{Patch:m,Node:k,Inlet:l,Outlet:e,Link:B},unit:b,not:function(a){return!a},event:M,events:V,
addPatch:function(a,c,h){return g(a,c).open(h)},addClosedPatch:g,renderNext:function(a,c,h){P||(P=q());P.emit({aliases:a,targets:c,config:h})},stopRendering:function(){P&&(P.end(),P=null)},nodetype:W,channeltype:y,nodedescription:function(a,c){Y[a]=c},renderer:function(a,c){T[a]=c},styles:O,style:function(a,c,h){O[a]||(O[a]={});O[a][c]=h},noderenderer:function(a,c,h){t[a]||x(null,"network","Node type '"+a+"' is not registered");R[a]||(R[a]={});R[a][c]=h},channelrenderer:function(a,c,h){K[a]||x(null,
"network","Channel type '"+a+"' is not registered");N[a]||(N[a]={});N[a][c]=h},toolkiticon:function(a,c){aa[a]=c},nodetypeicon:function(a,c){Z[a]=c},"import":{},"export":{},allNodeTypes:t,allChannelTypes:K,allNodeRenderers:R,allChannelRenderers:N,allNodeDescriptions:Y,allNodeTypeIcons:Z,allToolkitIcons:aa,getStyle:function(a,c){a||x(null,"network","Unknown style requested: '"+a+"'");O[a]||x(null,"network","Style '"+a+"' is not registered");var h=O[a][c];h||x(null,"network","Style '"+a+"' has no definition for '"+
c+"' renderer");return h},reportError:D,reportSystemError:x,short_uid:I,stringify:L,autoStringify:function(a){return a instanceof m?L.patch(a):a instanceof k?L.node(a):a instanceof l?L.inlet(a):a instanceof e?L.outlet(a):a instanceof B?L.link(a):"<?> "+a}}}();"function"===typeof define&&define.amd?(define([],function(){return a}),l.Rpd=a):"object"===typeof module&&"object"===typeof exports?(module.exports=a,a.Rpd=a):l.Rpd=a})(this);var d3_tiny=function(){function l(a,b,d){for(var g="function"===typeof b?b:function(){return b},m=a.selection,k=0,l=m.length;k<l;k++)d(m[k],g.bind(m[k])(k));return a}function d(a,b,d){b=b||document;selection="string"===typeof a?d?Array.prototype.slice.call(b.querySelectorAll(a),0):[b.querySelector(a)]:a instanceof Node?[a]:Array.isArray(a)?a:[a];this.namespace=1===selection.length&&selection[0]?selection[0].namespaceURI:null;this.selection=selection}d.prototype.empty=function(){return 1===this.selection.length&&
!this.selection[0]||!this.selection.length?!0:!1};d.prototype.attr=function(a,b){return"undefined"===typeof b&&1===this.selection.length?this.selection[0].getAttribute(a):l(this,b,function(b,d){b.setAttributeNS(null,a,d)})};d.prototype.property=function(a,b){return"undefined"===typeof b&&1===this.selection.length?this.selection[0][a]:l(this,b,function(b,d){b[a]=d})};d.prototype.style=function(a,b){"-"===a[0]&&(a=a.slice(1));a=a.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()});return l(this,
b,function(b,d){b.style[a]=d})};d.prototype.text=function(a){return"undefined"===typeof a&&1===this.selection.length?this.selection[0].textContent||this.selection[0].innerText:l(this,a,function(a,d){a.innerText=a.textContent=d})};d.prototype.classed=function(a,b){return"object"===typeof a?l(this,Object.keys(a),function(b,d){for(var m=0,k=d.length;m<k;m++)b.classList.toggle(d[m],a[d[m]])}):l(this,b,function(b,d){b.classList.toggle(a,d)})};d.prototype.select=function(a){return new d(a,this.selection[0])};
d.prototype.selectAll=function(a){return new d(a,this.selection[0],!0)};d.prototype.append=function(a){var b=[];l(this,"string"===typeof a?document.createElementNS(this.namespace,a):a,function(a,d){a.appendChild(d);b.push(d)});return new d(b)};d.prototype.remove=function(){return l(this,function(){return null},function(a){a.parentElement.removeChild(a)})};d.prototype.node=function(a){return this.selection[a||0]};d.prototype.on=function(a,b){return l(this,function(){return b},function(b,d){b.addEventListener(a,
d)})};d.prototype.data=function(a){return a?l(this,a,function(a,d){a.__data__=d}):this.node().__data__};d.prototype.call=function(a){a(this);return this};return{ns:{prefix:{svg:"https://www.w3.org/2000/svg",html:"https://www.w3.org/1999/xhtml"}},select:function(a,b){return new d(a,b)},selectAll:function(a,b){return new d(a,b,!0)}}}();Rpd.Render=function(){function l(a){this.nodeRects=[];this.edgePadding=a.edgePadding||{horizontal:30,vertical:20};this.boxPadding=a.boxPadding||{horizontal:20,vertical:30}}function d(a,b){this.canvas=a;this.style=b}function a(a,b){this.link=a;this.style=b;this.element=this.styledLink=null}function b(){this.vlinks=[]}function q(a){a.stopPropagation();return a}function g(a){return{x:a.clientX,y:a.clientY}}function m(a,b,c,e){Kefir.fromEvents(a,"click").map(q).map(k(e||!1)).scan(Rpd.not).onValue(function(a){a?
b():c()})}var k=Rpd.unit,w=d3_tiny||w;l.DEFAULT_LIMITS=[1E3,1E3];l.prototype.nextPosition=function(a,b,c){c=c||l.DEFAULT_LIMITS;a=this.nodeRects;var e=this.boxPadding,d=this.edgePadding,m=b.width;b=b.height;var g=a.length?a[a.length-1]:null,g={x:g?g.x:d.horizontal,y:g?g.y+g.height+e.vertical:d.vertical,width:m,height:b};g.y+b+d.vertical>c.height&&(g.x=g.x+m+e.horizontal,g.y=d.vertical);a.push(g);return{x:g.x,y:g.y}};d.prototype.add=function(a,b){var c=this.canvas,e=this.style,d=b.start,m=b.end,k=
b.drag;Kefir.fromEvents(a.node(),"mousedown").map(g).map(e.getLocalPos).flatMap(function(b){var u=d(),k=b.x-u.x,l=b.y-u.y;b=Kefir.fromEvents(c.node(),"mousemove").map(q).takeUntilBy(Kefir.merge([Kefir.fromEvents(c.node(),"mouseup"),Kefir.fromEvents(a.node(),"mouseup")])).map(g).map(e.getLocalPos).map(function(a){return{x:a.x-k,y:a.y-l}}).toProperty(function(){return u});b.last().onValue(m);return b}).onValue(k)};a.prototype.construct=function(a){if(this.styledLink)throw Error("VLink is already constructed");
this.styledLink=a=this.style.createLink(this.link);this.element=w.select(a.element);return this};a.prototype.rotate=function(a,b,c,e){var d=this.style;a=d.getLocalPos({x:a,y:b});c=d.getLocalPos({x:c,y:e});this.styledLink.rotate(a.x,a.y,c.x,c.y);return this};a.prototype.rotateI=function(a,b,c){var e=this.style.getInletPos(c);return this.rotate(a,b,e.x,c.y)};a.prototype.rotateO=function(a,b,c){a=this.style.getOutletPos(a);return this.rotate(a.x,a.y,b,c)};a.prototype.rotateOI=function(a,b){var c=this.style,
e=c.getOutletPos(a),c=c.getInletPos(b);return this.rotate(e.x,e.y,c.x,c.y)};a.prototype.update=function(){if(this.link){var a=this.link;this.rotateOI(a.outlet,a.inlet);return this}};a.prototype.appendTo=function(a){a.append(this.element.node());return this};a.prototype.removeFrom=function(a){this.element.remove();return this};a.prototype.noPointerEvents=function(){this.styledLink.noPointerEvents&&this.styledLink.noPointerEvents();return this};a.prototype.listenForClicks=function(){var a=this.link;
m(this.element.node(),function(){a.enable()},function(){a.disable()});return this};a.prototype.enable=function(){this.element.classed("rpd-disabled",!1)};a.prototype.disable=function(){this.element.classed("rpd-disabled",!0)};a.prototype.get=function(){return this.link};a.prototype.getElement=function(){return this.element.node()};b.prototype.clear=function(){this.vlinks=[]};b.prototype.add=function(a){this.vlinks.push(a);return a};b.prototype.remove=function(a){this.vlinks=this.vlinks.filter(function(b){return b!==
a})};b.prototype.forEach=function(a){this.vlinks.forEach(a)};b.prototype.updateAll=function(){this.forEach(function(a){a.update()})};b.prototype.count=function(){return this.vlinks.length};b.prototype.getLast=function(){return this.count()?this.vlinks[this.vlinks.length-1]:null};var e=function(){var a={};return function(b,c,e){c.classed("rpd-error",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){c.classed("rpd-error",!1);a[b]=null},e||1)}}(),B=function(){var a={};return function(b,c,e){c.classed("rpd-stale",
!1);c.classed("rpd-fresh",!0);a[b]&&clearTimeout(a[b]);a[b]=setTimeout(function(){c.classed("rpd-fresh",!1);c.classed("rpd-stale",!0);a[b]=null},e||1)}}();return{Placing:l,DragAndDrop:d,VLink:a,VLinks:b,mergeConfig:function(a,b){if(a){var c={};Object.keys(b).forEach(function(a){c[a]=b[a]});Object.keys(a).forEach(function(b){c[b]=a[b]});return c}return b},preventDefault:function(a){a.preventDefault();return a},stopPropagation:q,extractPos:g,addTarget:function(a){return function(b){return{pos:b,target:a}}},
addClickSwitch:m,addValueErrorEffect:e,addValueUpdateEffect:B,subscribeUpdates:function(a,b){b&&Object.keys(b).forEach(function(c){(function(c,b){a.event["node/add-inlet"].filter(function(a){return a.alias===b}).onValue(function(b){a.event["node/is-ready"].onValue(function(){c.default&&b.receive("function"===typeof c.default?c.default():c.default);if(c.valueOut)c.valueOut.onValue(function(a){b.receive(a)})})})})(b[c],c)})},reportErrorsToConsole:function(a){Rpd.events.onError(function(b){a.logErrors&&
(b.silent||(b.system?console.error(Error(b.type+" \u2014 "+b.message+". Subject: "+Rpd.autoStringify(b.subject))):console.log("Error:",b.type,"\u2014",b.message+". ","Subject: "+Rpd.autoStringify(b.subject),b.subject)))})}}}();Rpd.style("compact-v","svg",function(){function l(b){return document.createElementNS(a.ns.prefix.svg,b)}function d(a){a=a.getBoundingClientRect();return{x:a.left,y:a.top}}var a=a||d3_tiny;return function(b){function q(a,b,d,g){var c=a+(d-a)/2;return"M"+a+" "+b+" C"+c+" "+b+" "+c+" "+g+" "+d+" "+g}var g,m={},k={},w={};return{edgePadding:{horizontal:20,vertical:40},boxPadding:{horizontal:20,vertical:80},createCanvas:function(b,d){return{element:a.select(l("g")).classed("rpd-patch",!0).node()}},createNode:function(b,
d,g,k){function c(a,c,b){a=16+20*(Math.max(a,c)-1);return{width:b.width,height:Math.max(10+a,10+b.height)}}function r(){var a=I,b=c(F,w,q);if(b.width!==a.width||b.height!==a.height)p.select("rect.rpd-shadow").attr("height",b.height).attr("width",b.width),p.select("rect.rpd-body").attr("height",b.height).attr("width",b.width),p.select("rect.rpd-content").attr("height",b.height-10),p.select("g.rpd-process").attr("transform","translate("+b.width*H.x+","+(10+(b.height-10)/2)+")"),I=b}function C(){D.forEach(function(a,
c){a.attr("transform","translate(0,"+(8+20*c)+")")});x.forEach(function(a,c){a.attr("transform","translate(0,"+(8+20*c)+")")})}var q=d.size?{width:d.size.width||60,height:d.size.height||25}:{width:60,height:25},H=d.pivot||{x:.5,y:.5};d=c(b.def.inlets?Object.keys(b.def.inlets).length:0,b.def.outlets?Object.keys(b.def.outlets).length:0,q);k=d.width;var z=d.height,p=a.select(l("g")).attr("class","rpd-node");p.append("rect").attr("class","rpd-shadow").attr("width",k).attr("height",z).attr("x",5).attr("y",
6).attr("rx",3).attr("ry",3);p.append("rect").attr("class","rpd-header").classed("rpd-drag-handle",!0).attr("x",0).attr("y",0).attr("width",k).attr("height",10);p.append("g").attr("class","rpd-name-holder").attr("transform","translate(0, 3)").append("text").attr("class","rpd-name").text(b.def.title||b.type).attr("x",3).attr("y",2).style("pointer-events","none");p.append("rect").attr("class","rpd-content").attr("x",0).attr("y",10).attr("width",k).attr("height",z-10);p.append("rect").attr("class","rpd-body").attr("width",
k).attr("height",z).style("pointer-events","none");p.select(".rpd-header").append(l("title")).text(g?g+" ("+b.type+")":b.type);p.append("g").attr("class","rpd-remove-button").attr("transform","translate("+(k-10.5)+",0.5)").call(function(a){a.append("rect").attr("width",10).attr("height",9.5).attr("class","rpd-remove-button-handle");a.append("text").text("x").attr("x",3).attr("y",1.5).style("pointer-events","none")});p.append("g").attr("class","rpd-inlets").attr("transform","translate(0,10)").data({position:{x:0,
y:10}});p.append("g").attr("class","rpd-process").attr("transform","translate("+k*H.x+","+(10+(z-10)*H.y)+")");p.append("g").attr("class","rpd-outlets").attr("transform","translate("+k+",10)").data({position:{x:k,y:10}});p.classed("rpd-"+b.type.slice(0,b.type.indexOf("/"))+"-toolkit-node",!0).classed("rpd-"+b.type.replace("/","-"),!0);var F=0,w=0,D=[],x=[],I=d;m[b.id]={inlet:function(a){F++;D.push(a);r();C()},outlet:function(a){w++;x.push(a);r();C()}};return{element:p.node(),size:d}},createInlet:function(b,
d){var g=a.select(l("g")).attr("class","rpd-inlet");g.call(function(a){a.append("rect").attr("class","rpd-connector").attr("x",-2).attr("y",-2).attr("width",4).attr("height",4);a.append("text").attr("class","rpd-name").text(b.def.label||b.alias).attr("x",-5).attr("y",0);a.append("g").attr("class","rpd-value-holder").attr("transform","translate(-5,7)").append("text").attr("class","rpd-value")});m[b.node.id].inlet(g);k[b.id]=g.select(".rpd-connector");return{element:g.node()}},createOutlet:function(b,
d){var g=a.select(l("g")).attr("class","rpd-outlet");g.call(function(a){a.append("rect").attr("class","rpd-connector").attr("x",-2).attr("y",-2).attr("width",4).attr("height",4);a.append("text").attr("class","rpd-name").text(b.def.label||b.alias).attr("x",5).attr("y",0);a.append("g").attr("class","rpd-value-holder").attr("transform","translate(5,7)").append("text").attr("class","rpd-value").attr("x",0).attr("y",0).style("pointer-events","none")});m[b.node.id].outlet(g);w[b.id]=g.select(".rpd-connector");
return{element:g.node()}},createLink:function(d){var g=a.select(l(b.linkForm&&"curve"==b.linkForm?"path":"line")).attr("class","rpd-link");return{element:g.node(),rotate:function(a,d,c,e){b.linkForm&&"curve"==b.linkForm?g.attr("d",q(a,d,c,e)):g.attr("x1",a).attr("y1",d).attr("x2",c).attr("y2",e)},noPointerEvents:function(){g.style("pointer-events","none")}}},getInletPos:function(a){a=d(k[a.id].node());return{x:a.x+2,y:a.y+2}},getOutletPos:function(a){a=d(w[a.id].node());return{x:a.x+2,y:a.y+2}},getLocalPos:function(a){if(!g)return a;
var b=d(g.node());return{x:a.x-b.x,y:a.y-b.y}},onPatchSwitch:function(b,d){g=a.select(d)},onNodeRemove:function(a){m[a.id]=null}}}}());(function(){function l(a){return document.createElementNS(k.ns.prefix.svg,a)}function d(b){return function(d,g){var p=E(g,m);w.reportErrorsToConsole(p);var y=Rpd.getStyle(p.style,"svg")(p);d=k.select(d).classed("rpd-network",!0).classed("rpd-full-page",p.fullPage);var t,Q,K;return{"patch/is-ready":function(h){var v=k.select(document.documentElement);t=k.select(l("svg")).attr("width",d.property("clientWidth")).attr("height",d.property("clientHeight")).classed("rpd-canvas",!0);t.append("rect").attr("class",
"rpd-background");p.fullPage&&(t.attr("width","100%").attr("height",v.property("clientHeight")),t.select(".rpd-background").attr("width","100%").attr("height",v.property("clientHeight")));var g=t.append(y.createCanvas(b,d).element).classed("rpd-style-"+p.style,!0).classed("rpd-values-"+(p.valuesOnHover?"on-hover":"always-shown"),!0).classed("rpd-show-boxes",p.showBoxes).data(h.patch);e.patches[b.id]=t.data({canvas:g,width:v.property("clientWidth"),height:v.property("clientHeight"),patch:h.patch});
p.fullPage&&a(window,document,t,t.select(".rpd-background"));e.patchToPlacing[b.id]=new w.Placing(y);e.patchToLinks[b.id]=new C;Q=new c(t,y,p);p.nodeMovingAllowed&&(K=new w.DragAndDrop(t,y));Kefir.fromEvents(t.node(),"selectstart").onValue(H)},"patch/open":function(a){(p.closeParent||p.fullPage)&&a.parent&&a.parent.close();B=a.patch;var b=e.patches[a.patch.id];d.append(b.node());e.patchToLinks[a.patch.id].updateAll();if(y.onPatchSwitch)y.onPatchSwitch(B,b.node())},"patch/close":function(a){B=null;
t.remove()},"patch/refer":function(a){var c=e.nodes[a.node.id];c.select(".rpd-node").classed("rpd-patch-reference",!0);c.data().processTarget.append(l("text")).text("["+(a.target.name||a.target.id)+"]");Kefir.fromEvents(c.data().processTarget.node(),"click").onValue(function(a,b){return function(){b.open(a)}}(b,a.target))},"patch/move-canvas":function(a){t.style("position","relative");t.style("top",Math.floor(a.position[0])+"px");t.style("left",Math.floor(a.position[1])+"px")},"patch/resize-canvas":function(a){t.attr("width",
a.size[0]);t.attr("height",a.size[1]);t.select(".rpd-background").attr("width","100%").attr("height","100%")},"patch/add-node":function(a){var c=a.node,d=a.render;a=e.patchToPlacing[a.patch.id];var g=e.patches[B.id].data(),r=k.select(l("g")).attr("class","rpd-node-box"),m=y.createNode(c,d,n[c.type],u[c.type]),t=r.append(m.element);e.nodes[c.id]=r.data({inletsTarget:t.select(".rpd-inlets"),outletsTarget:t.select(".rpd-outlets"),processTarget:t.select(".rpd-process"),position:q,size:m.size});var q=
a.nextPosition(c,m.size,{width:g.width,height:g.height});c.move(q.x,q.y);var E=new C;e.nodeToLinks[c.id]=E;if(p.nodeMovingAllowed){var J=t.select(".rpd-shadow"),q=t.select(".rpd-drag-handle");q.empty()||K.add(q,{start:function(){t.classed("rpd-dragging",!0);J.empty()||J.attr("x",7).attr("y",8);return r.data().position},drag:function(a){r.attr("transform","translate("+a.x+","+a.y+")");E.forEach(function(a){a.update()})},end:function(a){c.move(a.x,a.y);J.empty()||J.attr("x",5).attr("y",6);t.classed("rpd-dragging",
!1)}})}d.prepare&&d.prepare.bind(c)(e.patches[b.id].node(),e.patches[B.id].node());d.first&&x(c,d.first.bind(c)(t.select(".rpd-process").node()));if(d.always)c.event["node/process"].throttle(100).onValue(function(){E.updateAll()});if(!t.select(".rpd-remove-button").empty())Kefir.fromEvents(t.select(".rpd-remove-button-handle").node(),"click").map(z).onValue(function(){b.removeNode(c)});e.patches[c.patch.id].data().canvas.append(r.node())},"patch/remove-node":function(a){a=a.node;var c=e.nodes[a.id];
e.nodeToLinks[a.id].forEach(function(a){a.get().disconnect()});c.remove();if(y.onNodeRemove)y.onNodeRemove(a);e.nodes[a.id]=null;e.nodeToLinks[a.id]=null},"node/move":function(a){var c=e.nodes[a.node.id];a=a.position;c.attr("transform","translate("+Math.floor(a[0])+","+Math.floor(a[1])+")");c.data().position={x:a[0],y:a[1]}},"node/process":function(a){var c=a.node,b=a.render;if(b.always){var d=e.nodes[c.id].data().processTarget.node();b.always.bind(c)(d,a.inlets,a.outlets)}},"node/add-inlet":function(a){var c=
a.inlet;if(!c.def.hidden){var b=e.nodes[a.node.id].data().inletsTarget;a=a.render;var d;d=k.select(y.createInlet(c,a).element);d.classed("rpd-"+c.type.replace("/","-"),!0);d.classed({"rpd-stale":!0,"rpd-readonly":c.def.readonly||!1,"rpd-cold":c.def.cold||!1});var g=null;!c.def.readonly&&a.edit&&(g=new q(c,a,t,d.select(".rpd-value-holder"),d.select(".rpd-value"),k.select(l("g"))),d.select(".rpd-value-holder").append(g.editorElm.node()));e.inlets[c.id]=d.data({connector:d.select(".rpd-connector"),value:d.select(".rpd-value"),
vlinks:new C,editor:g});c.event["inlet/update"].onError(function(){G(c.id,d,p.effectTime)});Q.subscribeInlet(c,d.select(".rpd-connector"));b.append(d.node())}},"node/add-outlet":function(a){var c=a.outlet,b=e.nodes[a.node.id].data().outletsTarget;a=k.select(y.createOutlet(c,a.render).element);a.classed("rpd-"+c.type.replace("/","-"),!0);a.classed("rpd-stale",!0);e.outlets[c.id]=a.data({connector:a.select(".rpd-connector"),value:a.select(".rpd-value"),vlinks:new C});Q.subscribeOutlet(c,a.select(".rpd-connector"));
b.append(a.node())},"node/remove-inlet":function(a){a=a.inlet;e.inlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});e.inlets[a.id].remove();if(y.onInletRemove)y.onInletRemove(a);e.inlets[a.id]=null},"node/remove-outlet":function(a){a=a.outlet;e.outlets[a.id].data().vlinks.forEach(function(a){a.get().disconnect()});e.outlets[a.id].remove();if(y.onOutletRemove)y.onOutletRemove(a);e.outlets[a.id]=null},"inlet/update":function(a){var c=a.inlet;if(!c.def.hidden){var b=a.render,d=e.inlets[c.id],
g=d.data().value;if(!g.empty()){var r=c.def.show?c.def.show(a.value):a.value;b.show?b.show.bind(c)(g.node(),a.value,r):g.text(r)}D(c.id,d,p.effectTime)}},"outlet/update":function(a){var c=a.outlet,b=a.render,d=e.outlets[c.id],g=d.data().value;if(!g.empty()){var r=c.def.show?c.def.show(a.value):a.value;b.show?b.show.bind(c)(g.node(),a.value,r):g.text(r)}D(c.id,d,p.effectTime)},"outlet/connect":function(a){a=a.link;var c=a.outlet,d=a.inlet,g=e.inlets[d.id],m=e.outlets[c.id].data(),g=g.data();if(!p.inletAcceptsMultipleLinks&&
1===g.vlinks.count())throw Error("Inlet is already connected to a link");g.editor&&g.editor.disable();var q=new r(a,y);q.construct(p.linkWidth).rotateOI(c,d);k.select(q.getElement()).classed("rpd-"+d.type.replace("/","-"),!0).classed("rpd-"+c.type.replace("/","-"),!0);e.links[a.id]=q;m.vlinks.add(q);g.vlinks.add(q);e.nodeToLinks[c.node.id].add(q);c.node.id!==d.node.id&&e.nodeToLinks[d.node.id].add(q);e.patchToLinks[b.id].add(q);q.listenForClicks();q.appendTo(t)},"outlet/disconnect":function(a){a=
a.link;var c=e.links[a.id],d=a.outlet,g=a.inlet,r=e.outlets[d.id].data(),m=e.inlets[g.id].data();e.links[a.id]=null;r.vlinks.remove(c);m.vlinks.remove(c);e.nodeToLinks[d.node.id].remove(c);d.node.id!==g.node.id&&e.nodeToLinks[g.node.id].remove(c);e.patchToLinks[b.id].remove(c);c.removeFrom(t)},"link/enable":function(a){var c=e.inlets[a.link.inlet.id].data();c.editor&&c.editor.disable();e.links[a.link.id].enable()},"link/disable":function(a){e.links[a.link.id].disable()}}}}function a(a,c,b,d){Kefir.fromEvents(a,
"resize").map(function(){return a.innerHeight||c.documentElement.clientHeight||c.body.clientHeight}).onValue(function(a){b.attr("height",a);d.attr("height",a);b.data().height=a});b.data().subscribedToResize=!0}function b(a,c){return Kefir.merge([a.map(g(!0)),c.map(g(!1))]).toProperty(g(!1))}function q(a,c,b,d,r,m){var k=Kefir.emitter(),p=Kefir.emitter();this.disableEditor=p;this.editorElm=m;this.valueElm=r;m.classed("rpd-value-editor",!0);c.edit.bind(a)(m.node(),a,k).onValue(function(c){a.receive(c)});
Kefir.combine([Kefir.merge([Kefir.fromEvents(d.node(),"click").map(z).map(g(!0)),Kefir.fromEvents(b.node(),"click").merge(p).map(g(!1))]).toProperty(g(!1)).skipDuplicates()],[a.event["inlet/update"]]).map(function(a){return{lastValue:a[1],startEditing:a[0],cancelEditing:!a[0]}}).onValue(function(c){if(c.startEditing){var b=e.inlets[a.id].data();b.link&&b.link.disable();k.emit(c.lastValue);d.classed("rpd-editor-enabled",!0)}else c.cancelEditing&&(r.classed("rpd-edited",!0),d.classed("rpd-editor-enabled",
!1))});d.classed("rpd-editor-disabled",!0)}var g=Rpd.unit,m={style:"quartz",fullPage:!1,valuesOnHover:!1,showBoxes:!1,nodeMovingAllowed:!0,inletAcceptsMultipleLinks:!1,closeParent:!1,logErrors:!0,effectTime:1E3},k=k||d3_tiny,w=Rpd.Render,e={patches:{},nodes:{},inlets:{},outlets:{},links:{},patchToPlacing:{},patchToLinks:{},nodeToLinks:{}},B,n=Rpd.allNodeDescriptions,u=Rpd.allNodeTypeIcons,c=function(){function a(c){return e.inlets[c.id].data().vlinks}function c(b){return function(){return 0<a(b).count()}}
function d(a){1===a.count()&&(a=a.getLast().link,a.outlet.disconnect(a))}function m(a,c){a.forEach(function(a){a.link.outlet.id===c.id&&c.disconnect(a.link)})}function q(a,c,d){this.canvas=a;this.style=c;this.config=d;this.canvasClicks=Kefir.fromEvents(this.canvas.node(),"click");this.inletClicks=Kefir.pool();this.outletClicks=Kefir.pool();this.startLink=Kefir.emitter();this.finishLink=Kefir.emitter();this.doingLink=b(this.startLink,this.finishLink)}q.prototype.subscribeOutlet=function(c,e){var q=
this.canvas,h=this.style,l=this.config,C=this.canvasClicks,n=this.outletClicks,E=this.inletClicks,J=this.startLink,x=this.finishLink,u=this.doingLink;n.plug(Kefir.fromEvents(e.node(),"click").map(p).map(F(c)));Kefir.fromEvents(e.node(),"click").map(z).filterBy(b(n,u)).map(p).onValue(function(b){J.emit();var e=(new r(null,h)).construct(l.linkWidth).rotateO(c,b.x,b.y).noPointerEvents().appendTo(q);k.select(e.getElement()).classed("rpd-"+c.type.replace("/","-"),!0);Kefir.fromEvents(q.node(),"mousemove").takeUntilBy(Kefir.merge([E,
n.map(g(!1)),C.map(g(!1))]).take(1).onValue(function(b){if(b){b=b.target;var e=a(b);l.inletAcceptsMultipleLinks?m(e,c):d(e);c.connect(b)}})).map(p).onValue(function(a){e.rotateO(c,a.x,a.y)}).onEnd(function(){e.removeFrom(q);x.emit()})})};q.prototype.subscribeInlet=function(e,q){var l=this.canvas,h=this.style,n=this.config,C=this.canvasClicks,E=this.outletClicks,x=this.inletClicks,u=this.startLink,H=this.finishLink,y=this.doingLink;x.plug(Kefir.fromEvents(q.node(),"click").map(p).map(F(e)));Kefir.fromEvents(q.node(),
"click").map(z).filterBy(b(x,y)).filter(c(e)).onValue(function(c){var b=a(e).getLast().link,q=b.outlet;q.disconnect(b);u.emit();var z=(new r(null,h)).construct(n.linkWidth).rotateO(q,c.x,c.y).noPointerEvents().appendTo(l);k.select(z.getElement()).classed("rpd-"+e.type.replace("/","-"),!0).classed("rpd-"+q.type.replace("/","-"),!0);Kefir.fromEvents(l.node(),"mousemove").takeUntilBy(Kefir.merge([x,E.map(g(!1)),C.map(g(!1))]).take(1).onValue(function(c){if(c){c=c.target;var b=a(c);n.inletAcceptsMultipleLinks?
m(b,q):d(b);q.connect(c)}})).map(p).onValue(function(a){z.rotateO(q,a.x,a.y)}).onEnd(function(){z.removeFrom(l);H.emit()})})};return q}();q.prototype.disable=function(){this.valueElm.classed("rpd-edited",!1);this.disableEditor.emit()};var r=w.VLink,C=w.VLinks,E=w.mergeConfig,H=w.preventDefault,z=w.stopPropagation,p=w.extractPos,F=w.addTarget,G=w.addValueErrorEffect,D=w.addValueUpdateEffect,x=w.subscribeUpdates;Rpd.SvgRenderer=d;Rpd.renderer("svg",d)})();var RpdUtils=function(){function l(a){return 15<a?a.toString(16):"0"+a.toString(16)}function d(a){this.listElements=[];this.selected=null;this.markSelected=a.markSelected;this.markDeselected=a.markDeselected;this.markAdding=a.markAdding;this.markAdded=a.markAdded;this.recalculateSize=a.recalculateSize;this.setVisible=a.setVisible;this.setInvisible=a.setInvisible;this.getPatch=a.getPatch;this.searchInput=a.createSearchInput();this.clearSearchButton=a.createClearSearchButton();var b=a.buildList();this.clearingEvents=
Kefir.fromEvents(this.clearSearchButton.node(),"click").onValue(function(){this.selectNothing();a.clearSearchInput(this.searchInput)}.bind(this));for(var d=0;d<b.length;d++)b[d].visible=!0,b[d].prev=0<d?b[d-1]:b[b.length-1],b[d].next=d<b.length-1?b[d+1]:b[0];this.listElements=b;this.currentlyVisible=b.length}d.prototype.select=function(a){this.selected&&this.markDeselected(this.selected);(this.selected=a)&&this.markSelected(a)};d.prototype.selectNothing=function(){this.select(null)};d.prototype.addOnClick=
function(){var a=this;this.listElements.forEach(function(b){Kefir.fromEvents(b.element.node(),"click").onValue(function(){a.select(b);a.addNode(b)})})};d.prototype.addNode=function(a){this.markAdding(a);setTimeout(function(){this.markAdded(a)}.bind(this),1E3);this.getPatch().addNode(a.def.fullName)};d.prototype.addSearch=function(){var a=this,b=this.searchInput;Kefir.fromEvents(b.node(),"input").merge(this.clearingEvents).throttle(500).map(function(){return b.node().value}).onValue(function(b){var d=
a.currentlyVisible;a.currentlyVisible=0;a.listElements.forEach(function(d){var g=d.def.fullName.indexOf(b);0<=g?a.setVisible(d):a.setInvisible(d);d.visible=0<=g;d.visible&&a.currentlyVisible++});a.recalculateSize(a.listElements,d,a.currentlyVisible)})};d.prototype.addCtrlSpaceAndArrows=function(){var a=this,b=this.listElements,d=this.searchInput;Kefir.merge([Kefir.fromEvents(document.body,"keyup").filter(function(a){return(32==a.which||32==a.keyCode)&&(a.altKey||a.metaKey||a.ctrlKey)}),Kefir.fromEvents(d.node(),
"click")]).flatMap(function(g){d.node().focus();0<b.length&&a.select(b[0]);return Kefir.fromEvents(document.body,"keyup").map(function(a){return a.which||a.keyCode}).filter(function(a){return 38===a||40===a}).map(function(a){return 38===a?"up":"down"}).takeUntilBy(Kefir.merge([Kefir.fromEvents(document.body,"keyup").filter(function(a){return 13==a.which||13==a.keyCode}).map(function(){return!0}),Kefir.fromEvents(document.body,"keyup").filter(function(a){return 27==a.which||27==a.keyCode}).map(function(){return!1}),
Kefir.fromEvents(document.body,"click").filter(function(a){return a.target!==d.node()}).map(function(){return!1}),a.clearingEvents.map(function(){return!1})]).take(1).onValue(function(b){b&&a.selected&&a.addNode(a.selected);d.node().blur();a.selectNothing()})).onValue(function(g){if(0!=a.currentlyVisible){d.node().blur();if("up"===g)for(var k=a.selected?a.selected.prev:b[b.length-1];k&&!k.visible;)k=k.prev;else if("down"===g)for(k=a.selected?a.selected.next:b[0];k&&!k.visible;)k=k.next;k&&a.select(k)}})}).onValue(function(){})};
return{adaptToState:function(a,b){return Math.floor(100*(a.min+(a.max-a.min)*b))/100},numberToHex:l,toHexColor:function(a){return"#"+l(a.r||0)+l(a.g||0)+l(a.b||0)},getNodeTypesByToolkit:function(a){return Object.keys(a).reduce(function(b,d){var g=d.indexOf("/"),l=0>g?l:d.substring(0,g),g=0>g?"":d.substring(g+1);b[l]||(b[l]={icon:"",types:[]});b[l].types.push({toolkit:l,fullName:d,name:g,data:a[d]});return b},{})},NodeList:d}}();(function(){var l=RpdUtils.toHexColor;Rpd.channeltype("util/number",{default:0,readonly:!1,accept:function(a){if(Infinity===a)return!0;a=parseFloat(a);return!isNaN(a)&&isFinite(a)},adapt:function(a){return parseFloat(a)}});Rpd.channeltype("util/wholenumber",{default:0,readonly:!0,allow:["util/number"],accept:function(a){if(Infinity===a)return!0;a=parseFloat(a);return!isNaN(a)&&isFinite(a)},adapt:function(a){return Math.floor(parseFloat(a))}});Rpd.channeltype("util/time",{default:1E3,accept:function(a){a=
parseFloat(a);return!isNaN(a)&&isFinite(a)},adapt:function(a){return parseFloat(a)},show:function(a){return Math.floor(a/10)/100+"s"}});Rpd.channeltype("util/bang",{show:function(a){return a?"[Bang]":"[None]"},adapt:function(a){return a?{}:null}});Rpd.channeltype("util/color",{show:l});Rpd.channeltype("util/timestamped",{adapt:function(a){return{value:a,timestamp:(new Date).getTime()}}});Rpd.nodetype("util/number",{title:"number",inlets:{"user-value":{type:"util/number",default:0,hidden:!0}},outlets:{number:{type:"util/number"}},
process:function(a){return{number:a["user-value"]}}});Rpd.nodetype("util/random",function(){return{title:"random",inlets:{bang:{type:"util/bang",default:{}},min:{type:"util/number",default:0},max:{type:"util/number",default:100}},outlets:{random:{type:"util/number"}},process:function(a){return{random:Math.floor(a.min+Math.random()*(a.max-a.min))}}}});Rpd.nodetype("util/bounded-number",{title:"bounded number",inlets:{min:{type:"util/number",default:0},max:{type:"util/number",default:Infinity},spinner:{type:"util/number",
default:0,hidden:!0}},outlets:{number:{type:"util/number"}},process:function(a){if(a.hasOwnProperty("spinner"))return{number:a.spinner}}});Rpd.channeltype("util/boolean",{default:!1,readonly:!1,adapt:function(a){return a?!0:!1}});Rpd.nodedescription("util/empty","Does not allow adding any inlets or outlets.");Rpd.nodetype("util/empty",{title:"empty",handle:{"inlet/add":function(){throw Error("Empty node can not have any inlets");},"outlet/add":function(){throw Error("Empty node can not have any outlets");
}}});Rpd.nodetype("util/comment",{inlets:{text:{type:"core/any",hidden:!0},width:{type:"core/any",hidden:!0}},process:function(){}});Rpd.nodetype("util/bang",{title:"bang",inlets:{trigger:{type:"util/bang",hidden:!0}},outlets:{bang:{type:"util/bang"}},process:function(a){return a.trigger?{bang:{}}:{}}});Rpd.nodetype("util/metro",function(){var a,b=!0,d=Kefir.pool();return{title:"metro",inlets:{enabled:{type:"util/boolean",default:!0},period:{type:"util/time",default:3E3}},outlets:{bang:{type:"util/bang"}},
process:function(g){a&&(b=!1,d.unplug(a));if(g.enabled||b)return a=Kefir.interval(g.period,{}),d.plug(a),b?{bang:d}:{}}}});Rpd.nodetype("util/color",{title:"color",inlets:{r:{type:"util/wholenumber",default:237,label:"red"},g:{type:"util/wholenumber",default:34,label:"green"},b:{type:"util/wholenumber",default:93,label:"blue"}},outlets:{color:{type:"util/color"}},process:function(a){return{color:a}}});Rpd.nodetype("util/sum-of-three",{title:"sum of three",inlets:{a:{type:"util/number",label:"A"},
b:{type:"util/number",label:"B"},c:{type:"util/number",label:"C"}},outlets:{sum:{type:"util/number",label:"\u2211"}},process:function(a){return{sum:(a.a||0)+(a.b||0)+(a.c||0)}}});var d=RpdUtils.adaptToState;Rpd.nodetype("util/knob",{title:"knob",inlets:{min:{type:"util/number",default:0},max:{type:"util/number",default:100},submit:{type:"util/number",default:0,hidden:!0}},outlets:{number:{type:"util/number"}},process:function(a){return{number:d(a,a.submit)}}});Rpd.channeltype("util/numbers",{show:function(a,
b){return function(d){return d?0==d.length?"No "+b:1==d.length?"One "+a:2==d.length?"Two "+b:d.length+" "+b:"Nothing"}}("number","numbers")});Rpd.nodetype("util/knobs",{title:"knobs",inlets:{min:{type:"util/number",default:0},max:{type:"util/number",default:100},count:{type:"util/number",default:4,hidden:!0},submit:{type:"util/numbers",default:[],hidden:!0}},outlets:{numbers:{type:"util/numbers"}},process:function(a){return{numbers:a.submit?a.submit.map(function(b){return d(a,b)}):[]}}});Rpd.nodedescription("util/log",
"Log everything that goes in to console");Rpd.nodetype("util/log",{title:"log",inlets:{what:{type:"core/any"}},process:function(a){}});Rpd.nodetype("util/letter",{title:"letter",inlets:{code:{type:"util/wholenumber"}},outlets:{letter:{type:"core/any"}},process:function(a){return{letter:String.fromCharCode(a.code+97)}}});Rpd.nodetype("util/*",{title:"*",inlets:{a:{type:"util/number"},b:{type:"util/number"}},outlets:{result:{type:"util/number"}},process:function(a){return{result:(a.a||0)*(a.b||0)}}});
Rpd.nodetype("util/+",{title:"+",inlets:{a:{type:"util/number"},b:{type:"util/number"}},outlets:{result:{type:"util/number"}},process:function(a){return{result:(a.a||0)+(a.b||0)}}});Rpd.nodetype("util/-",{title:"-",inlets:{a:{type:"util/number"},b:{type:"util/number"}},outlets:{result:{type:"util/number"}},process:function(a){return{result:(a.a||0)-(a.b||0)}}});Rpd.nodetype("util/\u00f7",{title:"/",inlets:{a:{type:"util/number"},b:{type:"util/number"}},outlets:{result:{type:"util/number"}},process:function(a){return{result:(a.a||
0)/(a.b||0)}}});Rpd.nodetype("util/mod",{title:"%",inlets:{a:{type:"util/number"},b:{type:"util/number"}},outlets:{result:{type:"util/number"}},process:function(a){return{result:(a.a||0)%(a.b||0)}}});Rpd.nodetype("util/mouse-pos",{title:"mouse",inlets:{x:{type:"util/number",hidden:!0,"default":0},y:{type:"util/number",hidden:!0,"default":0}},outlets:{x:{type:"util/number"},y:{type:"util/number"}},process:function(a){return a}});Rpd.nodetype("util/mouse-pos-by-bang",{title:"mouse + bang",inlets:{bang:{type:"util/bang"},
x:{type:"util/number",hidden:!0,"default":0,cold:!0},y:{type:"util/number",hidden:!0,"default":0,cold:!0}},outlets:{x:{type:"util/number"},y:{type:"util/number"}},process:function(a){return{x:a.x,y:a.y}}});Rpd.nodedescription("util/nodelist","Add any node to active patch by type");Rpd.nodetype("util/nodelist",{title:"add nodes"});Rpd.nodetypeicon("util/number","\ud83d\udd22");Rpd.nodetypeicon("util/log","\ud83d\uddd2");Rpd.nodetypeicon("util/nodelist","\ud83d\udcc3");Rpd.nodetypeicon("util/knob",
"\ud83c\udf9b");Rpd.nodetypeicon("util/knobs","\ud83c\udf9b");Rpd.nodetypeicon("util/color","\ud83c\udfee");Rpd.nodetypeicon("util/bang","\u2299");Rpd.nodetypeicon("util/metro","\u229a");Rpd.nodetypeicon("util/empty","\u2205");Rpd.nodetypeicon("util/mouse-pos","\ud83d\uddb1");Rpd.nodetypeicon("util/mouse-pos-by-bang","\ud83d\uddb1")})();(function(){function l(a){a.stopPropagation();return a}function d(a){return document.createElementNS(g.ns.prefix.svg,a)}function a(a,b){var d=0;return{init:function(e){var k,n,p,q,u=Kefir.emitter();g.select(e).call(function(a){p=a.append("circle").attr("r",b.radius).style("fill","rgba(200, 200, 200, .2)").style("stroke-width",2).style("stroke","#000");n=a.append("line").style("visibility","hidden").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",b.radius-1).style("stroke-width",2).style("stroke",
"rgba(255,255,255,0.1)");k=a.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",b.radius).style("stroke-width",2).style("stroke","#000");q=a.append("text").style("text-anchor","middle").style("fill","#fff").text(0)});Kefir.fromEvents(e,"mousedown").map(l).flatMap(function(){n.style("visibility","visible");var a=Kefir.fromEvents(document.body,"mousemove").takeUntilBy(Kefir.fromEvents(document.body,"mouseup")).map(l).map(function(a){var c=p.node().getBoundingClientRect();return{x:a.clientX-
(c.left+b.radius),y:a.clientY-(c.top+b.radius)}}).map(function(a){a=(a.y*b.speed*-1+180)/360;0>a?a=0:1<a&&(a=1);return a});a.last().onValue(function(a){d=a;n.attr("transform","rotate("+360*d+")").style("visibility","hidden");u.emit(d)});return a}).onValue(function(b){q.text(m(a,b));k.attr("transform","rotate("+360*b+")")});return u}}}function b(a,b,d,e,k){var l;g.select(b).append("g").attr("transform","translate("+(d*k+k/2-e*k/2)+",0)").call(function(b){a.root=b;l=a.init(b.node())});return l}function q(){var a,
b,e,g=Kefir.fromEvents(document.body,"mousemove").throttle(16).map(function(a){return a.x}),k=Kefir.fromEvents(document.body,"mousemove").throttle(16).map(function(a){return a.y});return{size:{width:50,height:50},first:function(l){var p=d("g");b=d("circle");a=d("line");e=d("text");a.setAttributeNS(null,"x1",0);a.setAttributeNS(null,"y1",0);a.setAttributeNS(null,"x2",0);a.setAttributeNS(null,"y2",-20);b.setAttributeNS(null,"r",20);p.appendChild(b);p.appendChild(a);l.appendChild(p);l.appendChild(e);
return{x:{"default":0,valueOut:g},y:{"default":0,valueOut:k}}},always:function(d,g,k){Number.isNaN(g.x)||Number.isNaN(g.y)||!g.y||(d=b.getBoundingClientRect(),d=Math.atan2(g.y-(d.top+20),g.x-(d.left+20)),a.setAttributeNS(null,"x2",20*Math.cos(d)),a.setAttributeNS(null,"y2",20*Math.sin(d)),e.innerHTML=e.innerText="<"+g.x+":"+g.y+">")}}}var g=g||d3_tiny;Rpd.channelrenderer("util/number","svg",{edit:function(a,b,e){b=d("foreignObject");b.setAttributeNS(null,"width",20);b.setAttributeNS(null,"height",
30);var k=document.createElementNS(g.ns.prefix.html,"input");k.type="number";e.onValue(function(a){k.value=a});b.appendChild(k);a.appendChild(b);return Kefir.fromEvents(k,"change").map(function(){return k.value})}});Rpd.noderenderer("util/random","svg",function(){return{size:{width:40}}});Rpd.noderenderer("util/comment","svg",function(){var a;return{size:{width:100,height:150},first:function(b){a=g.select(b).append("text")},always:function(b,d,e){d.width&&a.attr("width",d.width);a.text(d.text||"<empty>")}}});
Rpd.noderenderer("util/log","svg",function(){var a,b=[];return{size:{width:140,height:30},first:function(b){a=g.select(b).append("text")},always:function(d,e,g){e.what&&(5<b.length&&b.shift(),b.push(e.what));a.text(0<b.length?"..."+b.join(", ")+".":"...")}}});Rpd.noderenderer("util/letter","svg",function(){var a;return{first:function(b){a=g.select(b).append("text")},always:function(b,d,e){a.text(e.letter)}}});Rpd.noderenderer("util/bang","svg",{size:{width:30,height:25},first:function(a){var b=g.select(d("circle")).attr("r",
9).attr("fill","black").style("cursor","pointer").style("pointer-events","all");g.select(a).append(b.node());a=Kefir.fromEvents(b.node(),"click");a.onValue(function(){b.classed("rpd-util-bang-fresh",!0)});a.delay(500).onValue(function(){b.classed("rpd-util-bang-fresh",!1)});return{trigger:{valueOut:a.map(function(){return{}})}}}});Rpd.noderenderer("util/metro","svg",function(){var a;return{size:{width:30,height:25},first:function(b){a=g.select(d("circle")).attr("r",9).attr("fill","black").style("cursor",
"pointer").style("pointer-events","all");g.select(b).append(a.node())},always:function(b,d,e){if(e.bang)e.bang.onValue(function(){a.classed("rpd-util-metro-fresh",!0)}).delay(500).onValue(function(){a.classed("rpd-util-metro-fresh",!1)})}}});Rpd.noderenderer("util/sum-of-three","svg",function(){var a;return{size:{width:120,height:null},first:function(b){a=d("text");b.appendChild(a)},always:function(b,d,e){a.innerHTML="\u2211 ("+(d.a||"?")+", "+(d.b||"?")+", "+(d.c||"?")+") = "+(e.sum||"?")}}});var m=
RpdUtils.adaptToState,k={speed:1.5,radius:13,width:40,height:40};Rpd.noderenderer("util/knob","svg",function(){var b={min:0,max:100},d=a(b,k);return{size:{width:k.width,height:k.height},first:function(a){return{submit:{valueOut:d.init(a)}}},always:function(a,d,e){b.min=d.min||0;b.max=d.max||0}}});Rpd.noderenderer("util/knobs","svg",function(){for(var c={min:0,max:100},d=[],e=0;4>e;e++)d.push(a(c,k));var g;return{size:{width:4*k.width,height:k.height},first:function(a){var c=Kefir.pool();g=a;c=Kefir.combine(d.map(function(a,
c){return b(a,g,c,4,k.width).merge(Kefir.constant(0))}));return{submit:{valueOut:c}}},always:function(a,b,d){c.min=b.min||0;c.max=b.max||0}}});var w=RpdUtils.toHexColor;Rpd.noderenderer("util/color","svg",function(){var a;return{size:{width:50,height:50},first:function(b){a=d("rect");a.setAttributeNS(null,"width","30");a.setAttributeNS(null,"height","30");a.setAttributeNS(null,"rx","5");a.setAttributeNS(null,"ry","5");a.setAttributeNS(null,"transform","translate(-15,-15)");a.classList.add("rpd-util-color-display");
b.appendChild(a)},always:function(b,d,e){a.setAttributeNS(null,"fill",w(e.color))}}});Rpd.noderenderer("util/mouse-pos","svg",q);Rpd.noderenderer("util/mouse-pos-by-bang","svg",q);var e=RpdUtils.NodeList,B=RpdUtils.getNodeTypesByToolkit,n={width:180,height:300},u=n.width-40;Rpd.noderenderer("util/nodelist","svg",{size:n,first:function(a){var b=this.patch,k=Rpd.allNodeDescriptions,l=Rpd.allToolkitIcons,q=Rpd.allNodeTypeIcons,m=B(Rpd.allNodeTypes),p=g.select(a).append("g").attr("transform","translate("+
-1*n.width/2+","+-1*n.height/2+")"),w=p.append("g").classed("rpd-nodelist-search",!0).attr("transform","translate(12,12)"),G,D={},x={};a=new e({getPatch:function(){return b},buildList:function(){var a=[];p.node().getBoundingClientRect();G=p.append(d("foreignObject")).append(document.createElementNS(g.ns.prefix.html,"div")).style("width",n.width-20+"px").style("height",n.height-45+"px").style("overflow-y","scroll").style("position","fixed").style("left","10px").style("top","45px").append(d("svg")).classed("rpd-nodelist-list",
!0).attr("width",n.width-12+"px");var b=0;G.append("g").call(function(c){Object.keys(m).forEach(function(d){var e=c.append("g").classed("rpd-nodelist-toolkit",!0).attr("transform","translate(0,"+b+")").call(function(a){l[d]&&a.append("text").attr("class","rpd-nodelist-toolkit-icon").text(l[d]);a.append("text").attr("class","rpd-nodelist-toolkit-name").text(d)});D[d]=e;b+=22;c.append("g").classed("rpd-nodelist-nodetypes",!0).call(function(c){m[d].types.forEach(function(d){var e=d.fullName;c.append("g").classed("rpd-nodelist-nodetype",
!0).attr("transform","translate(0,"+b+")").call(function(c){var g=k[e]?!0:!1,l={def:d,element:c,hasDescription:g,initialY:b};c.data(l);c.append("rect").attr("class","rpd-nodelist-item-bg").attr("x",0).attr("y",-5).attr("rx",5).attr("ry",5).attr("width",n.width-20).attr("height",(g?33:22)-5);c.append("text").attr("class","rpd-nodelist-icon").text(q[e]||" ").attr("x",5.5).attr("y",5);c.append("text").attr("class","rpd-nodelist-fulltypename").attr("transform","translate(15,0)").text(d.toolkit+"/"+d.name);
g&&(b+=11,c.select("rect").attr("title",k[e]),c.append("text").attr("class","rpd-nodelist-description").attr("transform","translate(3,13.2)").text(k[e]));a.push(l);x[e]=a.length-1;b+=22})})})})});G.attr("height",b+"px");return a},recalculateSize:function(a){var b=0;Object.keys(m).forEach(function(c){D[c].attr("transform","translate(0,"+b+")");b+=22;var d,e;m[c].types.forEach(function(c){d=x[c.fullName];e=a[d];e.visible&&(e.element.attr("transform","translate(0,"+b+")"),b+=22,e.hasDescription&&(b+=
11))})});G.attr("height",b+"px")},createSearchInput:function(){var a=d("foreignObject");a.setAttributeNS(null,"width",u);a.setAttributeNS(null,"height",20);var b=document.createElementNS(g.ns.prefix.html,"input");b.setAttribute("type","text");b.style.width=u+"px";a.appendChild(b);w.append(a);return g.select(b)},createClearSearchButton:function(){w.append("rect").attr("transform","translate("+(n.width-32)+",7)").attr("width",12).attr("height",12).attr("rx",5);return w.append("text").text("x").attr("transform",
"translate("+(n.width-26)+",12)")},clearSearchInput:function(a){a.node().value=""},markSelected:function(a){a.element.classed("rpd-nodelist-selected",!0)},markDeselected:function(a){a.element.classed("rpd-nodelist-selected",!1)},markAdding:function(a){a.element.classed("rpd-nodelist-add-effect",!0)},markAdded:function(a){a.element.classed("rpd-nodelist-add-effect",!1)},setVisible:function(a){a.element.style("display","list-item")},setInvisible:function(a){a.element.style("display","none")}});a.addOnClick();
a.addSearch();a.addCtrlSpaceAndArrows()}})})();
